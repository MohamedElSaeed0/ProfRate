# ProfRate Full Code Context
# Generated: 2026-01-27 14:50:40
# Total Files: 46

================
File: AuthController.cs
Path: Controllers\AuthController.cs
================
using Microsoft.AspNetCore.Mvc;
using ProfRate.DTOs;
using ProfRate.Services;

namespace ProfRate.Controllers
{
    [Route("api/auth")]
    [ApiController]
    public class AuthController : ControllerBase
    {
        private readonly AuthService _authService;

        public AuthController(AuthService authService)
        {
            _authService = authService;
        }

        // POST: api/auth/login
        // تسجيل الدخول
        [HttpPost]
        [Route("login")]
        [Microsoft.AspNetCore.RateLimiting.EnableRateLimiting("login")]
        public async Task<IActionResult> Login([FromBody] LoginDTO loginDto)
        {
            var result = await _authService.Login(loginDto);

            if (result.Success)
            {
                return Ok(result);
            }

            return Unauthorized(result);
        }
    }
}


================
File: EvaluationController.cs
Path: Controllers\EvaluationController.cs
================
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using ProfRate.DTOs;
using ProfRate.Services;

namespace ProfRate.Controllers
{
    [Route("api/evaluations")]
    [ApiController]
    public class EvaluationController : ControllerBase
    {
        private readonly EvaluationService _evaluationService;

        public EvaluationController(EvaluationService evaluationService)
        {
            _evaluationService = evaluationService;
        }

        // GET: api/evaluations/GetAll
        // الحصول على كل التقييمات
        [HttpGet]
        [Route("GetAll")]
        public async Task<IActionResult> GetAllEvaluations()
        {
            var evaluations = await _evaluationService.GetAllEvaluations();
            return Ok(evaluations);
        }

        // GET: api/evaluations/GetByLecturer/5
        // الحصول على تقييمات محاضر معين
        [HttpGet]
        [Route("GetByLecturer/{lecturerId}")]
        public async Task<IActionResult> GetEvaluationsByLecturer(int lecturerId)
        {
            var evaluations = await _evaluationService.GetEvaluationsByLecturer(lecturerId);
            return Ok(evaluations);
        }

        // GET: api/evaluations/GetReport
        // الحصول على تقرير التقييمات
        [HttpGet]
        [Route("GetReport")]
        public async Task<IActionResult> GetEvaluationReport()
        {
            var report = await _evaluationService.GetEvaluationReport();
            return Ok(report);
        }

        // POST: api/evaluations/Add
        // إضافة تقييم جديد
        [HttpPost]
        [Route("Add")]
        [Authorize(Roles = "Student")] // الطلاب فقط هم من يقيمون
        public async Task<IActionResult> AddEvaluation([FromBody] EvaluationDTO dto)
        {
            try
            {
                var evaluation = await _evaluationService.AddEvaluation(dto);
                return Ok(new { message = "تمت إضافة التقييم بنجاح", evaluation });
            }
            catch (InvalidOperationException ex)
            {
                return BadRequest(new { message = ex.Message });
            }
        }

        // POST: api/evaluations/Reset
        // إعادة ضبط التقييمات (للأدمن فقط)
        [HttpPost]
        [Route("Reset")]
        [Authorize(Roles = "Admin")] // تفعيل الصلاحية للأدمن فقط
        public async Task<IActionResult> ResetEvaluations()
        {
            var result = await _evaluationService.ResetEvaluations();
            return Ok(new { message = result ? "تمت أرشفة التقييمات السابقة وبدء دورة جديدة بنجاح" : "لا توجد تقييمات نشطة للأرشفة" });
        }
    }
}


================
File: LecturerController.cs
Path: Controllers\LecturerController.cs
================
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using ProfRate.DTOs;
using ProfRate.Services;

namespace ProfRate.Controllers
{
    [Route("api/lecturers")]
    [ApiController]
    public class LecturerController : ControllerBase
    {
        private readonly LecturerService _lecturerService;

        public LecturerController(LecturerService lecturerService)
        {
            _lecturerService = lecturerService;
        }

        // GET: api/lecturers/GetAll
        // الحصول على كل المحاضرين
        [HttpGet]
        [Route("GetAll")]
        [Authorize] // يتطلب تسجيل الدخول
        public async Task<IActionResult> GetAllLecturers()
        {
            var lecturers = await _lecturerService.GetAllLecturers();
            // تحويل لـ DTO بدون الباسورد
            var safeLecturers = lecturers.Select(l => new LecturerResponseDTO
            {
                LecturerId = l.LecturerId,
                FirstName = l.FirstName,
                LastName = l.LastName,
                Username = l.Username,
                AdminId = l.AdminId
            });
            return Ok(safeLecturers);
        }

        // GET: api/lecturers/Search?query=...
        [HttpGet]
        [Route("Search")]
        [Authorize] // يتطلب تسجيل الدخول
        public async Task<IActionResult> Search([FromQuery] string query)
        {
            var lecturers = await _lecturerService.Search(query);
            var safeLecturers = lecturers.Select(l => new LecturerResponseDTO
            {
                LecturerId = l.LecturerId,
                FirstName = l.FirstName,
                LastName = l.LastName,
                Username = l.Username,
                AdminId = l.AdminId
            });
            return Ok(safeLecturers);
        }

        // GET: api/lecturers/GetById/5
        // الحصول على محاضر بالـ ID
        [HttpGet]
        [Route("GetById/{id}")]
        [Authorize(Roles = "Admin")] // الأدمن فقط
        public async Task<IActionResult> GetLecturerById(int id)
        {
            var lecturer = await _lecturerService.GetLecturerById(id);
            if (lecturer == null)
            {
                return NotFound(new { message = "المحاضر غير موجود" });
            }
            // للأدمن نرجع كل البيانات عشان يقدر يعدل
            return Ok(lecturer);
        }

        // POST: api/lecturers/Add
        // إضافة محاضر جديد
        [HttpPost]
        [Route("Add")]
        [Authorize(Roles = "Admin")] // الأدمن فقط يقدر يضيف
        public async Task<IActionResult> AddLecturer([FromBody] LecturerDTO dto)
        {
            try
            {
                var lecturer = await _lecturerService.AddLecturer(dto);
                return Ok(new { message = "تمت إضافة المحاضر بنجاح", lecturer });
            }
            catch (InvalidOperationException ex)
            {
                return BadRequest(new { message = ex.Message });
            }
            catch (Exception)
            {
                return StatusCode(500, new { message = "حدث خطأ أثناء إضافة المحاضر" });
            }
        }

        // PUT: api/lecturers/Update/5
        // تعديل محاضر
        [HttpPut]
        [Route("Update/{id}")]
        [Authorize(Roles = "Admin")] // الأدمن فقط يقدر يعدل
        public async Task<IActionResult> UpdateLecturer(int id, [FromBody] LecturerDTO dto)
        {
            var lecturer = await _lecturerService.UpdateLecturer(id, dto);
            if (lecturer == null)
            {
                return NotFound(new { message = "المحاضر غير موجود" });
            }
            return Ok(new { message = "تم تعديل المحاضر بنجاح", lecturer });
        }

        // DELETE: api/lecturers/Delete/5
        // حذف محاضر
        [HttpDelete]
        [Route("Delete/{id}")]
        [Authorize(Roles = "Admin")] // الأدمن فقط يقدر يحذف
        public async Task<IActionResult> DeleteLecturer(int id)
        {
            var result = await _lecturerService.DeleteLecturer(id);
            if (!result)
            {
                return NotFound(new { message = "المحاضر غير موجود" });
            }
            return Ok(new { message = "تم حذف المحاضر بنجاح" });
        }
    }
}


================
File: LecturerSubjectController.cs
Path: Controllers\LecturerSubjectController.cs
================
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using ProfRate.Data;
using ProfRate.Entities;

namespace ProfRate.Controllers
{
    [Route("api/lecturersubjects")]
    [ApiController]
    public class LecturerSubjectController : ControllerBase
    {
        private readonly ProfRate.Services.LecturerSubjectService _service;

        public LecturerSubjectController(ProfRate.Services.LecturerSubjectService service)
        {
            _service = service;
        }

        // GET: api/lecturersubjects/GetAll
        [HttpGet]
        [Route("GetAll")]
        [Authorize] // يتطلب تسجيل الدخول
        public async Task<IActionResult> GetAll()
        {
            var list = await _service.GetAll();
            return Ok(list);
        }

        // GET: api/lecturersubjects/GetByLecturer/5
        [HttpGet]
        [Route("GetByLecturer/{lecturerId}")]
        [Authorize] // يتطلب تسجيل الدخول
        public async Task<IActionResult> GetByLecturer(int lecturerId)
        {
            var list = await _service.GetByLecturer(lecturerId);
            return Ok(list);
        }

        // GET: api/lecturersubjects/GetBySubject/5
        [HttpGet]
        [Route("GetBySubject/{subjectId}")]
        [Authorize] // يتطلب تسجيل الدخول
        public async Task<IActionResult> GetBySubject(int subjectId)
        {
            var list = await _service.GetBySubject(subjectId);
            return Ok(list);
        }

        // POST: api/lecturersubjects/Add
        [HttpPost]
        [Route("Add")]
        [Authorize(Roles = "Admin")] // الأدمن فقط
        public async Task<IActionResult> Add([FromBody] ProfRate.DTOs.LecturerSubjectDTO model)
        {
            var result = await _service.AddLecturerSubject(model);
            if (!result.Success)
            {
                return BadRequest(new { message = result.Message });
            }
            return Ok(new { message = result.Message });
        }

        // PUT: api/lecturersubjects/Update/5
        [HttpPut]
        [Route("Update/{id}")]
        [Authorize(Roles = "Admin")] // الأدمن فقط
        public async Task<IActionResult> Update(int id, [FromBody] ProfRate.DTOs.LecturerSubjectDTO model)
        {
            var result = await _service.UpdateLecturerSubject(id, model);
            if (!result.Success)
            {
                return BadRequest(new { message = result.Message });
            }
            return Ok(new { message = result.Message });
        }

        // DELETE: api/lecturersubjects/Delete/5
        [HttpDelete]
        [Route("Delete/{id}")]
        [Authorize(Roles = "Admin")] // الأدمن فقط
        public async Task<IActionResult> Delete(int id)
        {
            var success = await _service.DeleteLecturerSubject(id);
            if (!success)
            {
                return NotFound(new { message = "غير موجود" });
            }
            return Ok(new { message = "تم الحذف بنجاح" });
        }
    }
}



================
File: QuestionController.cs
Path: Controllers\QuestionController.cs
================
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using ProfRate.DTOs;
using ProfRate.Services;

namespace ProfRate.Controllers
{
    [Route("api/questions")]
    [ApiController]
    public class QuestionController : ControllerBase
    {
        private readonly QuestionService _questionService;

        public QuestionController(QuestionService questionService)
        {
            _questionService = questionService;
        }

        // GET: api/questions/GetAll
        // الحصول على كل الأسئلة
        [HttpGet]
        [Route("GetAll")]
        [Authorize] // يتطلب تسجيل الدخول
        public async Task<IActionResult> GetAllQuestions()
        {
            var questions = await _questionService.GetAllQuestions();
            return Ok(questions);
        }

        // GET: api/questions/GetById/5
        // الحصول على سؤال بالـ ID
        [HttpGet]
        [Route("GetById/{id}")]
        [Authorize] // يتطلب تسجيل الدخول
        public async Task<IActionResult> GetQuestionById(int id)
        {
            var question = await _questionService.GetQuestionById(id);
            if (question == null)
            {
                return NotFound(new { message = "السؤال غير موجود" });
            }
            return Ok(question);
        }

        // POST: api/questions/Add
        // إضافة سؤال جديد
        [HttpPost]
        [Route("Add")]
        [Authorize(Roles = "Admin")] // الأدمن فقط يقدر يضيف
        public async Task<IActionResult> AddQuestion([FromBody] QuestionDTO dto)
        {
            var question = await _questionService.AddQuestion(dto);
            return Ok(new { message = "تمت إضافة السؤال بنجاح", question });
        }

        // PUT: api/questions/Update/5
        // تعديل سؤال
        [HttpPut]
        [Route("Update/{id}")]
        [Authorize(Roles = "Admin")] // الأدمن فقط يقدر يعدل
        public async Task<IActionResult> UpdateQuestion(int id, [FromBody] QuestionDTO dto)
        {
            var question = await _questionService.UpdateQuestion(id, dto);
            if (question == null)
            {
                return NotFound(new { message = "السؤال غير موجود" });
            }
            return Ok(new { message = "تم تعديل السؤال بنجاح", question });
        }

        // DELETE: api/questions/Delete/5
        // حذف سؤال
        [HttpDelete]
        [Route("Delete/{id}")]
        [Authorize(Roles = "Admin")] // الأدمن فقط يقدر يحذف
        public async Task<IActionResult> DeleteQuestion(int id)
        {
            var result = await _questionService.DeleteQuestion(id);
            if (!result)
            {
                return NotFound(new { message = "السؤال غير موجود" });
            }
            return Ok(new { message = "تم حذف السؤال بنجاح" });
        }
    }
}



================
File: StudentController.cs
Path: Controllers\StudentController.cs
================
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using ProfRate.DTOs;
using ProfRate.Services;

namespace ProfRate.Controllers
{
    [Route("api/students")]
    [ApiController]
    public class StudentController : ControllerBase
    {
        private readonly StudentService _studentService;

        public StudentController(StudentService studentService)
        {
            _studentService = studentService;
        }

        // GET: api/students/GetAll
        [HttpGet]
        [Route("GetAll")]
        [Authorize] // يتطلب تسجيل الدخول
        public async Task<IActionResult> GetAllStudents([FromQuery] int page = 1, [FromQuery] int pageSize = 20)
        {
            if (page < 1) page = 1;
            if (pageSize < 1 || pageSize > 100) pageSize = 20;

            var result = await _studentService.GetAllStudents(page, pageSize);
            
            // تحويل النتائج لـ DTO بدون الباسورد
            var safeResult = new
            {
                items = result.Items.Select(s => new StudentResponseDTO
                {
                    StudentId = s.StudentId,
                    FirstName = s.FirstName,
                    LastName = s.LastName,
                    Username = s.Username,
                    AdminId = s.AdminId
                }),
                result.TotalCount,
                result.CurrentPage,
                result.PageSize,
                result.TotalPages,
                result.HasPrevious,
                result.HasNext
            };
            return Ok(safeResult);
        }

        // GET: api/students/Search?query=...
        [HttpGet]
        [Route("Search")]
        [Authorize] // يتطلب تسجيل الدخول
        public async Task<IActionResult> Search([FromQuery] string query)
        {
            var students = await _studentService.Search(query);
            var safeStudents = students.Select(s => new StudentResponseDTO
            {
                StudentId = s.StudentId,
                FirstName = s.FirstName,
                LastName = s.LastName,
                Username = s.Username,
                AdminId = s.AdminId
            });
            return Ok(safeStudents);
        }

        // GET: api/students/GetById/5
        // الحصول على طالب بالـ ID
        [HttpGet]
        [Route("GetById/{id}")]
        [Authorize(Roles = "Admin")] // الأدمن فقط يشوف بيانات طالب معين
        public async Task<IActionResult> GetStudentById(int id)
        {
            var student = await _studentService.GetStudentById(id);
            if (student == null)
            {
                return NotFound(new { message = "الطالب غير موجود" });
            }
            // للأدمن نرجع كل البيانات عشان يقدر يعدل
            return Ok(student);
        }

        // POST: api/students/Add
        // إضافة طالب جديد
        [HttpPost]
        [Route("Add")]
        [Authorize(Roles = "Admin")] // الأدمن فقط يقدر يضيف
        public async Task<IActionResult> AddStudent([FromBody] StudentDTO dto)
        {
            try
            {
                var student = await _studentService.AddStudent(dto);
                return Ok(new { message = "تمت إضافة الطالب بنجاح", student });
            }
            catch (InvalidOperationException ex)
            {
                return BadRequest(new { message = ex.Message });
            }
            catch (Exception)
            {
                return StatusCode(500, new { message = "حدث خطأ أثناء إضافة الطالب" });
            }
        }

        // PUT: api/students/Update/5
        // تعديل طالب
        [HttpPut]
        [Route("Update/{id}")]
        [Authorize(Roles = "Admin")] // الأدمن فقط يقدر يعدل
        public async Task<IActionResult> UpdateStudent(int id, [FromBody] StudentDTO dto)
        {
            var student = await _studentService.UpdateStudent(id, dto);
            if (student == null)
            {
                return NotFound(new { message = "الطالب غير موجود" });
            }
            return Ok(new { message = "تم تعديل الطالب بنجاح", student });
        }

        // DELETE: api/students/Delete/5
        // حذف طالب
        [HttpDelete]
        [Route("Delete/{id}")]
        [Authorize(Roles = "Admin")] // الأدمن فقط يقدر يحذف
        public async Task<IActionResult> DeleteStudent(int id)
        {
            var result = await _studentService.DeleteStudent(id);
            if (!result)
            {
                return NotFound(new { message = "الطالب غير موجود" });
            }
            return Ok(new { message = "تم حذف الطالب بنجاح" });
        }
    }
}


================
File: StudentSubjectController.cs
Path: Controllers\StudentSubjectController.cs
================
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using ProfRate.Data;
using ProfRate.Entities;

namespace ProfRate.Controllers
{
    [Route("api/studentsubjects")]
    [ApiController]
    public class StudentSubjectController : ControllerBase
    {
        private readonly ProfRate.Services.StudentSubjectService _service;

        public StudentSubjectController(ProfRate.Services.StudentSubjectService service)
        {
            _service = service;
        }

        // GET: api/studentsubjects/GetAll
        [HttpGet]
        [Route("GetAll")]
        [Authorize] // يتطلب تسجيل الدخول
        public async Task<IActionResult> GetAll()
        {
            var list = await _service.GetAll();
            return Ok(list);
        }

        // GET: api/studentsubjects/GetByStudent/5
        [HttpGet]
        [Route("GetByStudent/{studentId}")]
        [Authorize] // يتطلب تسجيل الدخول
        public async Task<IActionResult> GetByStudent(int studentId)
        {
            var list = await _service.GetByStudent(studentId);
            return Ok(list);
        }

        // POST: api/studentsubjects/Add
        [HttpPost]
        [Route("Add")]
        [Authorize(Roles = "Admin")] // الأدمن فقط
        public async Task<IActionResult> Add([FromBody] ProfRate.DTOs.StudentSubjectDTO model)
        {
            var result = await _service.AddStudentSubject(model);
            if (!result.Success)
            {
                return BadRequest(new { message = result.Message });
            }
            return Ok(new { message = result.Message });
        }

        // PUT: api/studentsubjects/Update/5
        [HttpPut]
        [Route("Update/{id}")]
        [Authorize(Roles = "Admin")] // الأدمن فقط
        public async Task<IActionResult> Update(int id, [FromBody] ProfRate.DTOs.StudentSubjectDTO model)
        {
            var result = await _service.UpdateStudentSubject(id, model);
            if (!result.Success)
            {
                return BadRequest(new { message = result.Message });
            }
            return Ok(new { message = result.Message });
        }

        // DELETE: api/studentsubjects/Delete/5
        [HttpDelete]
        [Route("Delete/{id}")]
        [Authorize(Roles = "Admin")] // الأدمن فقط
        public async Task<IActionResult> Delete(int id)
        {
            var success = await _service.DeleteStudentSubject(id);
            if (!success)
            {
                return NotFound(new { message = "غير موجود" });
            }
            return Ok(new { message = "تم الحذف بنجاح" });
        }
    }
}



================
File: SubjectController.cs
Path: Controllers\SubjectController.cs
================
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using ProfRate.DTOs;
using ProfRate.Services;

namespace ProfRate.Controllers
{
    [Route("api/subjects")]
    [ApiController]
    public class SubjectController : ControllerBase
    {
        private readonly SubjectService _subjectService;

        public SubjectController(SubjectService subjectService)
        {
            _subjectService = subjectService;
        }

        // GET: api/subjects/GetAll
        // الحصول على كل المواد
        [HttpGet]
        [Route("GetAll")]
        [Authorize] // يتطلب تسجيل الدخول
        public async Task<IActionResult> GetAllSubjects()
        {
            var subjects = await _subjectService.GetAllSubjects();
            return Ok(subjects);
        }

        // GET: api/subjects/GetById/5
        // الحصول على مادة بالـ ID
        [HttpGet]
        [Route("GetById/{id}")]
        [Authorize] // يتطلب تسجيل الدخول
        public async Task<IActionResult> GetSubjectById(int id)
        {
            var subject = await _subjectService.GetSubjectById(id);
            if (subject == null)
            {
                return NotFound(new { message = "المادة غير موجودة" });
            }
            return Ok(subject);
        }

        // POST: api/subjects/Add
        // إضافة مادة جديدة
        [HttpPost]
        [Route("Add")]
        [Authorize(Roles = "Admin")] // الأدمن فقط يقدر يضيف
        public async Task<IActionResult> AddSubject([FromBody] SubjectDTO dto)
        {
            var subject = await _subjectService.AddSubject(dto);
            if (subject == null)
            {
                return BadRequest(new { message = "المادة موجودة مسبقاً" });
            }
            return Ok(new { message = "تمت إضافة المادة بنجاح", subject });
        }



        // DELETE: api/subjects/Delete/5
        // حذف مادة
        [HttpDelete]
        [Route("Delete/{id}")]
        [Authorize(Roles = "Admin")] // الأدمن فقط يقدر يحذف
        public async Task<IActionResult> DeleteSubject(int id)
        {
            var result = await _subjectService.DeleteSubject(id);
            if (!result)
            {
                return NotFound(new { message = "المادة غير موجودة" });
            }
            return Ok(new { message = "تم حذف المادة بنجاح" });
        }
    }
}



================
File: AppDbContext.cs
Path: Data\AppDbContext.cs
================
using Microsoft.EntityFrameworkCore;
using ProfRate.Entities;

namespace ProfRate.Data
{
    // الـ DbContext - بيربط الـ Entities بالـ Database
    public class AppDbContext : DbContext
    {
        // Constructor - بياخد الـ Options من Program.cs
        public AppDbContext(DbContextOptions<AppDbContext> options) : base(options)
        {
        }

        // الجداول في الـ Database
        public DbSet<Admin> Admins { get; set; }
        public DbSet<Student> Students { get; set; }
        public DbSet<Lecturer> Lecturers { get; set; }
        public DbSet<Question> Questions { get; set; }
        public DbSet<Subject> Subjects { get; set; }
        public DbSet<Evaluation> Evaluations { get; set; }
        public DbSet<StudentSubject> StudentSubjects { get; set; }
        public DbSet<LecturerSubject> LecturerSubjects { get; set; }

        // تحديد العلاقات بين الجداول
        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            base.OnModelCreating(modelBuilder);

            // Ensure Username is Unique for Students
            modelBuilder.Entity<Student>()
                .HasIndex(u => u.Username)
                .IsUnique();

            // Ensure Username is Unique for Lecturers
            modelBuilder.Entity<Lecturer>()
                .HasIndex(u => u.Username)
                .IsUnique();

            // Admin -> Students (One-to-Many)
            modelBuilder.Entity<Student>()
                .HasOne(s => s.Admin)
                .WithMany(a => a.Students)
                .HasForeignKey(s => s.AdminId)
                .OnDelete(DeleteBehavior.Restrict);

            // Admin -> Lecturers (One-to-Many)
            modelBuilder.Entity<Lecturer>()
                .HasOne(l => l.Admin)
                .WithMany(a => a.Lecturers)
                .HasForeignKey(l => l.AdminId)
                .OnDelete(DeleteBehavior.Restrict);

            // Admin -> Questions (One-to-Many)
            modelBuilder.Entity<Question>()
                .HasOne(q => q.Admin)
                .WithMany(a => a.Questions)
                .HasForeignKey(q => q.AdminId)
                .OnDelete(DeleteBehavior.Restrict);

            // Evaluation relationships
            modelBuilder.Entity<Evaluation>()
                .HasOne(e => e.Student)
                .WithMany(s => s.Evaluations)
                .HasForeignKey(e => e.StudentId)
                .OnDelete(DeleteBehavior.Restrict);

            modelBuilder.Entity<Evaluation>()
                .HasOne(e => e.Lecturer)
                .WithMany(l => l.Evaluations)
                .HasForeignKey(e => e.LecturerId)
                .OnDelete(DeleteBehavior.Restrict);

            modelBuilder.Entity<Evaluation>()
                .HasOne(e => e.Question)
                .WithMany(q => q.Evaluations)
                .HasForeignKey(e => e.QuestionId)
                .OnDelete(DeleteBehavior.Restrict);

            modelBuilder.Entity<Evaluation>()
                .HasOne(e => e.Subject)
                .WithMany(s => s.Evaluations)
                .HasForeignKey(e => e.SubjectId)
                .OnDelete(DeleteBehavior.Restrict);

            // StudentSubject (Many-to-Many junction table)
            modelBuilder.Entity<StudentSubject>()
                .HasOne(ss => ss.Student)
                .WithMany(s => s.StudentSubjects)
                .HasForeignKey(ss => ss.StudentId)
                .OnDelete(DeleteBehavior.Restrict);

            modelBuilder.Entity<StudentSubject>()
                .HasOne(ss => ss.Subject)
                .WithMany(s => s.StudentSubjects)
                .HasForeignKey(ss => ss.SubjectId)
                .OnDelete(DeleteBehavior.Restrict);

            modelBuilder.Entity<StudentSubject>()
                .HasOne(ss => ss.Lecturer)
                .WithMany()
                .HasForeignKey(ss => ss.LecturerId)
                .OnDelete(DeleteBehavior.Restrict);

            // LecturerSubject (Many-to-Many junction table)
            modelBuilder.Entity<LecturerSubject>()
                .HasOne(ls => ls.Lecturer)
                .WithMany(l => l.LecturerSubjects)
                .HasForeignKey(ls => ls.LecturerId)
                .OnDelete(DeleteBehavior.Restrict);

            modelBuilder.Entity<LecturerSubject>()
                .HasOne(ls => ls.Subject)
                .WithMany(s => s.LecturerSubjects)
                .HasForeignKey(ls => ls.SubjectId)
                .OnDelete(DeleteBehavior.Restrict);
        }
    }
}


================
File: AuthDTOs.cs
Path: DTOs\AuthDTOs.cs
================
namespace ProfRate.DTOs
{
    // DTO لتسجيل الدخول
    public class LoginDTO
    {
        public string Username { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public string UserType { get; set; } = string.Empty; // "Admin", "Student", "Lecturer"
    }

    // DTO للـ Response بعد تسجيل الدخول
    public class LoginResponseDTO
    {
        public bool Success { get; set; }
        public string Message { get; set; } = string.Empty;
        public string Token { get; set; } = string.Empty;
        public string UserType { get; set; } = string.Empty;
        public int UserId { get; set; }
        public string FirstName { get; set; } = string.Empty;
        public string FullName { get; set; } = string.Empty;
    }
}


================
File: EntityDTOs.cs
Path: DTOs\EntityDTOs.cs
================
using System.ComponentModel.DataAnnotations;

namespace ProfRate.DTOs
{
    // DTO لإضافة/تعديل طالب
    public class StudentDTO
    {
        public int StudentId { get; set; }
        
        [Required(ErrorMessage = "الاسم الأول مطلوب")]
        [StringLength(50, ErrorMessage = "الاسم يجب أن لا يزيد عن 50 حرف")]
        public string FirstName { get; set; } = string.Empty;

        [Required(ErrorMessage = "الاسم الأخير مطلوب")]
        [StringLength(50, ErrorMessage = "الاسم يجب أن لا يزيد عن 50 حرف")]
        public string LastName { get; set; } = string.Empty;

        [Required(ErrorMessage = "اسم المستخدم مطلوب")]
        [StringLength(50, MinimumLength = 3, ErrorMessage = "اسم المستخدم يجب أن يكون بين 3 و 50 حرف")]
        public string Username { get; set; } = string.Empty;

        [Required(ErrorMessage = "كلمة المرور مطلوبة")]
        [StringLength(100, MinimumLength = 6, ErrorMessage = "كلمة المرور يجب أن تكون 6 أحرف على الأقل")]
        public string Password { get; set; } = string.Empty;
        
        public int AdminId { get; set; }
    }

    // DTO لإضافة/تعديل محاضر
    public class LecturerDTO
    {
        public int LecturerId { get; set; }
        
        [Required(ErrorMessage = "الاسم الأول مطلوب")]
        [StringLength(50)]
        public string FirstName { get; set; } = string.Empty;

        [Required(ErrorMessage = "الاسم الأخير مطلوب")]
        [StringLength(50)]
        public string LastName { get; set; } = string.Empty;

        [Required(ErrorMessage = "اسم المستخدم مطلوب")]
        public string Username { get; set; } = string.Empty;

        [Required(ErrorMessage = "كلمة المرور مطلوبة")]
        [MinLength(6, ErrorMessage = "كلمة المرور قصيرة جداً")]
        public string Password { get; set; } = string.Empty;
        
        public int AdminId { get; set; }
    }

    // DTO لإضافة/تعديل سؤال
    public class QuestionDTO
    {
        public int QuestionId { get; set; }

        [Required(ErrorMessage = "نص السؤال مطلوب")]
        public string QuestionText { get; set; } = string.Empty;
        
        public int AdminId { get; set; }
    }

    // DTO لإضافة/تعديل مادة
    public class SubjectDTO
    {
        public int SubjectId { get; set; }

        [Required(ErrorMessage = "اسم المادة مطلوب")]
        public string SubjectName { get; set; } = string.Empty;
    }

    // DTO لإضافة تقييم
    public class EvaluationDTO
    {
        public int EvaluationId { get; set; }
        
        [Range(1, 5, ErrorMessage = "التقييم يجب أن يكون بين 1 و 5")]
        public byte Rating { get; set; }
        
        [Required]
        public int StudentId { get; set; }
        [Required]
        public int QuestionId { get; set; }
        [Required]
        public int LecturerId { get; set; }
        [Required]
        public int SubjectId { get; set; }
    }

    // DTO لعرض تقرير التقييمات
    public class EvaluationReportDTO
    {
        public int LecturerId { get; set; }
        public string LecturerName { get; set; } = string.Empty;
        public string SubjectName { get; set; } = string.Empty;
        public double AverageRating { get; set; }
        public int TotalEvaluations { get; set; }
    }

    public class StudentSubjectDTO
    {
        [Required]
        public int StudentId { get; set; }
        [Required]
        public int SubjectId { get; set; }
        public int? LecturerId { get; set; }
    }

    public class LecturerSubjectDTO
    {
        [Required]
        public int LecturerId { get; set; }
        [Required]
        public int SubjectId { get; set; }
    }

    // DTO للـ Response بدون كلمة المرور - للأمان
    public class StudentResponseDTO
    {
        public int StudentId { get; set; }
        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
        public string Username { get; set; } = string.Empty;
        public int AdminId { get; set; }
    }

    // DTO للـ Response بدون كلمة المرور - للأمان
    public class LecturerResponseDTO
    {
        public int LecturerId { get; set; }
        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
        public string Username { get; set; } = string.Empty;
        public int AdminId { get; set; }
    }
}


================
File: EvaluationResponseDTO.cs
Path: DTOs\EvaluationResponseDTO.cs
================
namespace ProfRate.DTOs
{
    public class EvaluationResponseDTO
    {
        public int EvaluationId { get; set; }
        public int Rating { get; set; }
        public bool IsArchived { get; set; }
        
        public string StudentName { get; set; } = "";
        public string ParticpantName { get; set; } = ""; // Student Name but generic? No, let's use StudentName
        public string QuestionText { get; set; } = "";
        public string LecturerName { get; set; } = "";
        public string SubjectName { get; set; } = "";
    }
}


================
File: PagedResult.cs
Path: DTOs\PagedResult.cs
================
namespace ProfRate.DTOs
{
    public class PagedResult<T>
    {
        public List<T> Items { get; set; } = new List<T>();
        public int TotalCount { get; set; }
        public int CurrentPage { get; set; }
        public int PageSize { get; set; }
        public int TotalPages { get; set; }
        public bool HasPrevious => CurrentPage > 1;
        public bool HasNext => CurrentPage < TotalPages;
    }
}


================
File: Admin.cs
Path: Entities\Admin.cs
================
namespace ProfRate.Entities
{
    public class Admin
    {
        public int AdminId { get; set; }
        public string Username { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;

        // Navigation Properties
        public List<Student> Students { get; set; } = new List<Student>();
        public List<Lecturer> Lecturers { get; set; } = new List<Lecturer>();
        public List<Question> Questions { get; set; } = new List<Question>();
    }
}


================
File: Evaluation.cs
Path: Entities\Evaluation.cs
================
namespace ProfRate.Entities
{
    // التقييم - الجدول الرئيسي للتقييمات
    public class Evaluation
    {
        public int EvaluationId { get; set; }
        public byte Rating { get; set; }  // التقييم من 1 لـ 5 مثلاً
        public bool IsArchived { get; set; } = false;

        // Foreign Keys
        public int StudentId { get; set; }
        public int QuestionId { get; set; }
        public int LecturerId { get; set; }
        public int SubjectId { get; set; }

        // Navigation Properties
        public Student Student { get; set; } = null!;
        public Question Question { get; set; } = null!;
        public Lecturer Lecturer { get; set; } = null!;
        public Subject Subject { get; set; } = null!;
    }
}


================
File: Lecturer.cs
Path: Entities\Lecturer.cs
================
using System.ComponentModel.DataAnnotations;

namespace ProfRate.Entities
{
    // المحاضر - اللي بيتقيم
    public class Lecturer
    {
        public int LecturerId { get; set; }
        
        [MaxLength(50)]
        public string FirstName { get; set; } = string.Empty;
        
        [MaxLength(50)]
        public string LastName { get; set; } = string.Empty;
        
        [MaxLength(50)]
        public string Username { get; set; } = string.Empty;
        
        [MaxLength(100)]
        public string Password { get; set; } = string.Empty;

        // Foreign Key
        public int AdminId { get; set; }

        // Navigation Properties
        public Admin Admin { get; set; } = null!;
        public List<Evaluation> Evaluations { get; set; } = new List<Evaluation>();
        public List<LecturerSubject> LecturerSubjects { get; set; } = new List<LecturerSubject>();
    }
}


================
File: LecturerSubject.cs
Path: Entities\LecturerSubject.cs
================
namespace ProfRate.Entities
{
    // جدول العلاقة بين المحاضرين والمواد (Many-to-Many)
    public class LecturerSubject
    {
        public int LecturerSubjectId { get; set; }

        // Foreign Keys
        public int LecturerId { get; set; }
        public int SubjectId { get; set; }

        // Navigation Properties
        public Lecturer Lecturer { get; set; } = null!;
        public Subject Subject { get; set; } = null!;
    }
}


================
File: Question.cs
Path: Entities\Question.cs
================
using System.ComponentModel.DataAnnotations;

namespace ProfRate.Entities
{
    // السؤال - أسئلة التقييم
    public class Question
    {
        public int QuestionId { get; set; }
        
        [MaxLength(200)]
        public string QuestionText { get; set; } = string.Empty;

        // Foreign Key
        public int AdminId { get; set; }

        // Navigation Properties
        public Admin Admin { get; set; } = null!;
        public List<Evaluation> Evaluations { get; set; } = new List<Evaluation>();
    }
}


================
File: Student.cs
Path: Entities\Student.cs
================
using System.ComponentModel.DataAnnotations;

namespace ProfRate.Entities
{
    // الطالب - اللي بيعمل التقييم
    public class Student
    {
        public int StudentId { get; set; }
        
        [MaxLength(50)]
        public string FirstName { get; set; } = string.Empty;
        
        [MaxLength(50)]
        public string LastName { get; set; } = string.Empty;
        
        [MaxLength(50)]
        public string Username { get; set; } = string.Empty;
        
        [MaxLength(100)]
        public string Password { get; set; } = string.Empty;

        // Foreign Key
        public int AdminId { get; set; }

        // Navigation Properties
        public Admin Admin { get; set; } = null!;
        public List<Evaluation> Evaluations { get; set; } = new List<Evaluation>();
        public List<StudentSubject> StudentSubjects { get; set; } = new List<StudentSubject>();
    }
}


================
File: StudentSubject.cs
Path: Entities\StudentSubject.cs
================
namespace ProfRate.Entities
{
    // جدول العلاقة بين الطلاب والمواد (Many-to-Many)
    public class StudentSubject
    {
        public int StudentSubjectId { get; set; }

        // Foreign Keys
        public int StudentId { get; set; }
        public int SubjectId { get; set; }
        public int? LecturerId { get; set; }

        // Navigation Properties
        public Student Student { get; set; } = null!;
        public Subject Subject { get; set; } = null!;
        public Lecturer? Lecturer { get; set; }
    }
}


================
File: Subject.cs
Path: Entities\Subject.cs
================
using System.ComponentModel.DataAnnotations;

namespace ProfRate.Entities
{
    // المادة الدراسية
    public class Subject
    {
        public int SubjectId { get; set; }
        
        [MaxLength(50)]
        public string SubjectName { get; set; } = string.Empty;

        // Navigation Properties
        public List<Evaluation> Evaluations { get; set; } = new List<Evaluation>();
        public List<StudentSubject> StudentSubjects { get; set; } = new List<StudentSubject>();
        public List<LecturerSubject> LecturerSubjects { get; set; } = new List<LecturerSubject>();
    }
}


================
File: ExceptionMiddleware.cs
Path: Middleware\ExceptionMiddleware.cs
================
using System.Net;
using System.Text.Json;

namespace ProfRate.Middleware
{
    public class ExceptionMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly ILogger<ExceptionMiddleware> _logger;

        public ExceptionMiddleware(RequestDelegate next, ILogger<ExceptionMiddleware> logger)
        {
            _next = next;
            _logger = logger;
        }

        public async Task InvokeAsync(HttpContext context)
        {
            try
            {
                await _next(context);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Something went wrong");
                await HandleExceptionAsync(context, ex);
            }
        }

        private static Task HandleExceptionAsync(HttpContext context, Exception exception)
        {
            context.Response.ContentType = "application/json";
            context.Response.StatusCode = (int)HttpStatusCode.InternalServerError;

            var isDevelopment = Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT") == "Development";

            var response = new
            {
                StatusCode = context.Response.StatusCode,
                Message = "حدث خطأ، يرجى المحاولة لاحقاً",
                Detailed = isDevelopment ? exception.Message : null // Show details only in Dev
            };
            
            return context.Response.WriteAsync(JsonSerializer.Serialize(response));
        }
    }
}


================
File: AuthService.cs
Path: Services\AuthService.cs
================
using Microsoft.EntityFrameworkCore;
using Microsoft.IdentityModel.Tokens;
using ProfRate.Data;
using ProfRate.DTOs;
using ProfRate.Entities;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;

namespace ProfRate.Services
{
    // Service للـ Authentication - تسجيل الدخول وإنشاء الـ Token
    public class AuthService
    {
        private readonly AppDbContext _context;
        private readonly IConfiguration _configuration;

        public AuthService(AppDbContext context, IConfiguration configuration)
        {
            _context = context;
            _configuration = configuration;
        }

        // تسجيل الدخول
        public async Task<LoginResponseDTO> Login(LoginDTO loginDto)
        {
            // البحث عن المستخدم حسب نوعه
            if (loginDto.UserType == "Admin")
            {
                var admin = await _context.Admins
                    .AsNoTracking()
                    .FirstOrDefaultAsync(a => a.Username == loginDto.Username && a.Password == loginDto.Password);

                if (admin != null)
                {
                    var token = GenerateToken(admin.AdminId, admin.Username, "Admin");
                    return new LoginResponseDTO
                    {
                        Success = true,
                        Message = "تم تسجيل الدخول بنجاح",
                        Token = token,
                        UserType = "Admin",
                        UserId = admin.AdminId,
                        FirstName = admin.FirstName,
                        FullName = admin.FirstName + " " + admin.LastName
                    };
                }
            }
            else if (loginDto.UserType == "Student")
            {
                var student = await _context.Students
                    .AsNoTracking()
                    .FirstOrDefaultAsync(s => s.Username == loginDto.Username && s.Password == loginDto.Password);

                if (student != null)
                {
                    var token = GenerateToken(student.StudentId, student.Username, "Student");
                    return new LoginResponseDTO
                    {
                        Success = true,
                        Message = "تم تسجيل الدخول بنجاح",
                        Token = token,
                        UserType = "Student",
                        UserId = student.StudentId,
                        FirstName = student.FirstName,
                        FullName = student.FirstName + " " + student.LastName
                    };
                }
            }
            else if (loginDto.UserType == "Lecturer")
            {
                var lecturer = await _context.Lecturers
                    .AsNoTracking()
                    .FirstOrDefaultAsync(l => l.Username == loginDto.Username && l.Password == loginDto.Password);

                if (lecturer != null)
                {
                    var token = GenerateToken(lecturer.LecturerId, lecturer.Username, "Lecturer");
                    return new LoginResponseDTO
                    {
                        Success = true,
                        Message = "تم تسجيل الدخول بنجاح",
                        Token = token,
                        UserType = "Lecturer",
                        UserId = lecturer.LecturerId,
                        FirstName = lecturer.FirstName,
                        FullName = lecturer.FirstName + " " + lecturer.LastName
                    };
                }
            }

            // لو مش موجود
            return new LoginResponseDTO
            {
                Success = false,
                Message = "اسم المستخدم أو كلمة المرور غير صحيحة",
                Token = "",
                UserType = "",
                UserId = 0
            };
        }

        // إنشاء الـ JWT Token
        private string GenerateToken(int userId, string username, string userType)
        {
            var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(_configuration["Jwt:Key"]!));
            var credentials = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);

            var claims = new[]
            {
                new Claim("UserId", userId.ToString()),
                new Claim("Username", username),
                new Claim("UserType", userType),
                new Claim(ClaimTypes.Role, userType)
            };

            var token = new JwtSecurityToken(
                issuer: _configuration["Jwt:Issuer"],
                audience: _configuration["Jwt:Audience"],
                claims: claims,
                expires: DateTime.Now.AddHours(24),
                signingCredentials: credentials
            );

            return new JwtSecurityTokenHandler().WriteToken(token);
        }
    }
}


================
File: EvaluationService.cs
Path: Services\EvaluationService.cs
================
using Microsoft.EntityFrameworkCore;
using ProfRate.Data;
using ProfRate.DTOs;
using ProfRate.Entities;

namespace ProfRate.Services
{
    // Service للـ Evaluations - إدارة التقييمات
    public class EvaluationService
    {
        private readonly AppDbContext _context;

        public EvaluationService(AppDbContext context)
        {
            _context = context;
        }

        // إضافة تقييم جديد مع التحقق من التكرار
        public async Task<Evaluation> AddEvaluation(EvaluationDTO dto)
        {
            if (dto.StudentId <= 0 || dto.LecturerId <= 0 || dto.SubjectId <= 0 || dto.QuestionId <= 0)
            {
                throw new InvalidOperationException("بيانات التقييم غير مكتملة (معرفات غير صالحة).");
            }

            // التحقق هل قام الطالب بتقييم هذا السؤال لنفس الدكتور والمادة من قبل في الدورة الحالية؟
            var exists = await _context.Evaluations
                .AnyAsync(e => e.StudentId == dto.StudentId && 
                               e.LecturerId == dto.LecturerId && 
                               e.SubjectId == dto.SubjectId && 
                               e.QuestionId == dto.QuestionId &&
                               !e.IsArchived);

            if (exists)
            {
                throw new InvalidOperationException("لقد قمت بتقييم هذا السؤال للمحاضر والمادة مسبقاً.");
            }

            var evaluation = new Evaluation
            {
                Rating = dto.Rating,
                StudentId = dto.StudentId,
                QuestionId = dto.QuestionId,
                LecturerId = dto.LecturerId,
                SubjectId = dto.SubjectId,
                IsArchived = false
            };

            _context.Evaluations.Add(evaluation);
            await _context.SaveChangesAsync();
            return evaluation;
        }

        // إعادة ضبط التقييمات (أرشفة الدورة الحالية)
        public async Task<bool> ResetEvaluations()
        {
            // الحصول على كل التقييمات النشطة
            var activeEvaluations = await _context.Evaluations
                .Where(e => !e.IsArchived)
                .ToListAsync();

            if (activeEvaluations.Any())
            {
                foreach (var eval in activeEvaluations)
                {
                    eval.IsArchived = true;
                }
                await _context.SaveChangesAsync();
                return true;
            }
            return false;
        }

        // الحصول على تقييمات محاضر معين (مجمعة وبدون أسماء طلاب)
        public async Task<List<EvaluationResponseDTO>> GetEvaluationsByLecturer(int lecturerId)
        {
            return await _context.Evaluations.AsNoTracking()
                .Include(e => e.Student)
                .Include(e => e.Lecturer)
                .Include(e => e.Subject)
                .Where(e => e.LecturerId == lecturerId && !e.IsArchived)
                .GroupBy(e => new { 
                    e.StudentId, 
                    // No need for Student details here as it should be anonymous
                    e.SubjectId, 
                    SubjectName = e.Subject.SubjectName 
                })
                .Select(g => new EvaluationResponseDTO
                {
                    EvaluationId = g.First().EvaluationId,
                    Rating = (int)Math.Round(g.Average(e => e.Rating)),
                    IsArchived = false,
                    StudentName = "طالب", // إخفاء هوية الطالب
                    LecturerName = "", // Not needed for own view
                    SubjectName = g.Key.SubjectName,
                    QuestionText = $"تقييم عام ({g.Count()} أسئلة)"
                })
                .ToListAsync();
        }

        // الحصول على تقرير التقييمات لكل محاضر
        public async Task<List<EvaluationReportDTO>> GetEvaluationReport()
        {
            var report = await _context.Evaluations.AsNoTracking()
                .Where(e => !e.IsArchived) // فقط التقييمات النشطة
                .GroupBy(e => new { e.LecturerId, e.Lecturer.FirstName, e.Lecturer.LastName, e.SubjectId, e.Subject.SubjectName })
                .Select(g => new EvaluationReportDTO
                {
                    LecturerId = g.Key.LecturerId,
                    LecturerName = g.Key.FirstName + " " + g.Key.LastName,
                    SubjectName = g.Key.SubjectName,
                    AverageRating = g.Average(e => e.Rating),
                    TotalEvaluations = g.Count()
                })
                .ToListAsync();

            return report;
        }

        // الحصول على كل التقييمات (مجمعة لكل طالب/دكتور/مادة)
        public async Task<List<EvaluationResponseDTO>> GetAllEvaluations()
        {
            return await _context.Evaluations.AsNoTracking()
                .Include(e => e.Student)
                .Include(e => e.Lecturer)
                .Include(e => e.Subject)
                .Where(e => !e.IsArchived)
                .GroupBy(e => new { 
                    e.StudentId, 
                    StudentFirstName = e.Student.FirstName, 
                    StudentLastName = e.Student.LastName,
                    e.LecturerId, 
                    LecturerFirstName = e.Lecturer.FirstName, 
                    LecturerLastName = e.Lecturer.LastName,
                    e.SubjectId, 
                    SubjectName = e.Subject.SubjectName 
                })
                .Select(g => new EvaluationResponseDTO
                {
                    EvaluationId = g.First().EvaluationId, // مجرد ID تمثيلي
                    Rating = (int)Math.Round(g.Average(e => e.Rating)), // متوسط التقييم للأسئلة
                    IsArchived = false,
                    StudentName = g.Key.StudentFirstName + " " + g.Key.StudentLastName,
                    LecturerName = g.Key.LecturerFirstName + " " + g.Key.LecturerLastName,
                    SubjectName = g.Key.SubjectName,
                    QuestionText = $"تقييم عام ({g.Count()} أسئلة)" // نص توضيحي بدل سؤال محدد
                })
                .ToListAsync();
        }
    }
}


================
File: LecturerService.cs
Path: Services\LecturerService.cs
================
using Microsoft.EntityFrameworkCore;
using ProfRate.Data;
using ProfRate.DTOs;
using ProfRate.Entities;

namespace ProfRate.Services
{
    // Service للـ Lecturers - إدارة المحاضرين
    public class LecturerService
    {
        private readonly AppDbContext _context;

        public LecturerService(AppDbContext context)
        {
            _context = context;
        }

        // الحصول على كل المحاضرين
        public async Task<List<Lecturer>> GetAllLecturers()
        {
            return await _context.Lecturers.AsNoTracking().OrderBy(l => l.FirstName).ToListAsync();
        }

        // البحث عن محاضرين (بالاسم أو اسم المستخدم)
        public async Task<List<Lecturer>> Search(string query)
        {
            if (string.IsNullOrWhiteSpace(query))
                return new List<Lecturer>();
            
            // Sanitize Input
            query = query.Trim();
            if (query.Length > 100) query = query.Substring(0, 100);
            query = System.Text.RegularExpressions.Regex.Replace(query, @"[^\w\s\u0600-\u06FF]", "");

            return await _context.Lecturers
                .AsNoTracking()
                .Where(l => l.Username.Contains(query) || 
                            (l.FirstName + " " + l.LastName).Contains(query))
                .OrderBy(l => l.FirstName)
                .Take(100)
                .ToListAsync();
        }

        // الحصول على محاضر بالـ ID
        public async Task<Lecturer?> GetLecturerById(int id)
        {
            return await _context.Lecturers.FindAsync(id);
        }

        // إضافة محاضر جديد
        public async Task<Lecturer> AddLecturer(LecturerDTO dto)
        {
            if (await _context.Lecturers.AnyAsync(l => l.Username == dto.Username))
                throw new InvalidOperationException("اسم المستخدم موجود بالفعل");

            var lecturer = new Lecturer
            {
                FirstName = dto.FirstName,
                LastName = dto.LastName,
                Username = dto.Username,
                Password = dto.Password, // Reverted to Plain Text
                AdminId = dto.AdminId
            };

            _context.Lecturers.Add(lecturer);
            await _context.SaveChangesAsync();
            return lecturer;
        }

        // تعديل محاضر
        public async Task<Lecturer?> UpdateLecturer(int id, LecturerDTO dto)
        {
            var lecturer = await _context.Lecturers.FindAsync(id);
            if (lecturer == null) return null;

            if (await _context.Lecturers.AnyAsync(l => l.Username == dto.Username && l.LecturerId != id))
                throw new InvalidOperationException("اسم المستخدم موجود بالفعل");

            lecturer.FirstName = dto.FirstName;
            lecturer.LastName = dto.LastName;
            lecturer.Username = dto.Username;
            lecturer.Password = dto.Password; // Reverted to Plain Text

            await _context.SaveChangesAsync();
            return lecturer;
        }

        // حذف محاضر
        // حذف محاضر (مع حذف كل بياناته المرتبطة)
        public async Task<bool> DeleteLecturer(int id)
        {
            var lecturer = await _context.Lecturers
                .Include(l => l.Evaluations)
                .Include(l => l.LecturerSubjects)
                .FirstOrDefaultAsync(l => l.LecturerId == id);

            if (lecturer == null) return false;

            // Manual Cascade Delete
            if (lecturer.Evaluations.Any())
                _context.Evaluations.RemoveRange(lecturer.Evaluations);

            if (lecturer.LecturerSubjects.Any())
                _context.LecturerSubjects.RemoveRange(lecturer.LecturerSubjects);

            _context.Lecturers.Remove(lecturer);
            await _context.SaveChangesAsync();
            return true;
        }
    }
}


================
File: LecturerSubjectService.cs
Path: Services\LecturerSubjectService.cs
================
using Microsoft.EntityFrameworkCore;
using ProfRate.Data;
using ProfRate.DTOs;
using ProfRate.Entities;

namespace ProfRate.Services
{
    // Service للـ LecturerSubjects - إدارة ربط المحاضرين بالمواد
    public class LecturerSubjectService
    {
        private readonly AppDbContext _context;

        public LecturerSubjectService(AppDbContext context)
        {
            _context = context;
        }

        // الحصول على كل الارتباطات
        public async Task<List<LecturerSubject>> GetAll()
        {
            return await _context.LecturerSubjects
                .Include(ls => ls.Lecturer)
                .Include(ls => ls.Subject)
                .ToListAsync();
        }

        // الحصول على مواد محاضر معين
        public async Task<List<LecturerSubject>> GetByLecturer(int lecturerId)
        {
            return await _context.LecturerSubjects
                .Where(ls => ls.LecturerId == lecturerId)
                .Include(ls => ls.Subject)
                .ToListAsync();
        }

        // الحصول على محاضرين مادة معينة
        public async Task<List<LecturerSubject >> GetBySubject(int subjectId)
        {
            return await _context.LecturerSubjects
                .Where(ls => ls.SubjectId == subjectId)
                .Include(ls => ls.Lecturer)
                .ToListAsync();
        }

        // إضافة ربط جديد
        public async Task<(bool Success, string Message)> AddLecturerSubject(LecturerSubjectDTO dto)
        {
            var exists = await _context.LecturerSubjects
                .AnyAsync(ls => ls.LecturerId == dto.LecturerId && ls.SubjectId == dto.SubjectId);
            
            if (exists)
            {
                return (false, "هذا المحاضر معين بالفعل لهذه المادة");
            }

            var entry = new LecturerSubject
            {
                LecturerId = dto.LecturerId,
                SubjectId = dto.SubjectId
            };

            _context.LecturerSubjects.Add(entry);
            await _context.SaveChangesAsync();
            return (true, "تم ربط المحاضر بالمادة بنجاح");
        }

        // تعديل ربط
        public async Task<(bool Success, string Message)> UpdateLecturerSubject(int id, LecturerSubjectDTO dto)
        {
            var entry = await _context.LecturerSubjects.FindAsync(id);
            if (entry == null) return (false, "هذا السجل غير موجود");

            bool exists = await _context.LecturerSubjects
                .AnyAsync(ls => ls.LecturerId == dto.LecturerId && ls.SubjectId == dto.SubjectId && ls.LecturerSubjectId != id);

            if (exists)
            {
                return (false, "هذا المحاضر معين بالفعل لهذه المادة");
            }

            // Capture old values
            var oldLecturerId = entry.LecturerId;
            var oldSubjectId = entry.SubjectId;

            // Apply new values
            entry.LecturerId = dto.LecturerId;
            entry.SubjectId = dto.SubjectId;

            // Cascade Update: Update related StudentAssignments
            var affectedStudents = await _context.StudentSubjects
                .Where(ss => ss.LecturerId == oldLecturerId && ss.SubjectId == oldSubjectId)
                .ToListAsync();

            if (affectedStudents.Any())
            {
                foreach (var studentSubject in affectedStudents)
                {
                    studentSubject.LecturerId = dto.LecturerId;
                    studentSubject.SubjectId = dto.SubjectId; // Usually subject stays same in this specific edit scenario, but safe to sync
                }
            }

            await _context.SaveChangesAsync();
            return (true, "تم تعديل الربط بنجاح (وتم تحديث بيانات الطلاب المرتبطين)");
        }

        // حذف ربط
        public async Task<bool> DeleteLecturerSubject(int id)
        {
            var entry = await _context.LecturerSubjects.FindAsync(id);
            if (entry == null) return false;

            _context.LecturerSubjects.Remove(entry);
            await _context.SaveChangesAsync();
            return true;
        }
    }
}


================
File: QuestionService.cs
Path: Services\QuestionService.cs
================
using Microsoft.EntityFrameworkCore;
using ProfRate.Data;
using ProfRate.DTOs;
using ProfRate.Entities;

namespace ProfRate.Services
{
    // Service للـ Questions - إدارة الأسئلة
    public class QuestionService
    {
        private readonly AppDbContext _context;

        public QuestionService(AppDbContext context)
        {
            _context = context;
        }

        // الحصول على كل الأسئلة
        public async Task<List<Question>> GetAllQuestions()
        {
            return await _context.Questions.ToListAsync();
        }

        // الحصول على سؤال بالـ ID
        public async Task<Question?> GetQuestionById(int id)
        {
            return await _context.Questions.FindAsync(id);
        }

        // إضافة سؤال جديد
        public async Task<Question> AddQuestion(QuestionDTO dto)
        {
            var question = new Question
            {
                QuestionText = dto.QuestionText,
                AdminId = dto.AdminId
            };

            _context.Questions.Add(question);
            await _context.SaveChangesAsync();
            return question;
        }

        // تعديل سؤال
        public async Task<Question?> UpdateQuestion(int id, QuestionDTO dto)
        {
            var question = await _context.Questions.FindAsync(id);
            if (question == null) return null;

            question.QuestionText = dto.QuestionText;

            await _context.SaveChangesAsync();
            return question;
        }

        // حذف سؤال
        // حذف سؤال (مع حذف تقييماته المرتبطة)
        public async Task<bool> DeleteQuestion(int id)
        {
            var question = await _context.Questions
                .Include(q => q.Evaluations)
                .FirstOrDefaultAsync(q => q.QuestionId == id);

            if (question == null) return false;

            if (question.Evaluations.Any())
                _context.Evaluations.RemoveRange(question.Evaluations);

            _context.Questions.Remove(question);
            await _context.SaveChangesAsync();
            return true;
        }
    }
}


================
File: StudentService.cs
Path: Services\StudentService.cs
================
using Microsoft.EntityFrameworkCore;
using ProfRate.Data;
using ProfRate.DTOs;
using ProfRate.Entities;

namespace ProfRate.Services
{
    // Service للـ Students - إدارة الطلاب
    public class StudentService
    {
        private readonly AppDbContext _context;

        public StudentService(AppDbContext context)
        {
            _context = context;
        }

        // الحصول على كل الطلاب (مع Pagination)
        public async Task<PagedResult<Student>> GetAllStudents(int page = 1, int pageSize = 20)
        {
            var totalStudents = await _context.Students.CountAsync();

            var students = await _context.Students
                .AsNoTracking()
                .OrderBy(s => s.FirstName)
                .Skip((page - 1) * pageSize)
                .Take(pageSize)
                .ToListAsync();

            return new PagedResult<Student>
            {
                Items = students,
                TotalCount = totalStudents,
                CurrentPage = page,
                PageSize = pageSize,
                TotalPages = (int)Math.Ceiling(totalStudents / (double)pageSize)
            };
        }

        // البحث عن طلاب (بالاسم أو اسم المستخدم)
        public async Task<List<Student>> Search(string query)
        {
            if (string.IsNullOrWhiteSpace(query))
                return new List<Student>();

            // Sanitize Input
            query = query.Trim();
            if (query.Length > 100) query = query.Substring(0, 100);
            query = System.Text.RegularExpressions.Regex.Replace(query, @"[^\w\s\u0600-\u06FF]", "");

            return await _context.Students
                .AsNoTracking()
                .Where(s => s.Username.Contains(query) || 
                            (s.FirstName + " " + s.LastName).Contains(query))
                .OrderBy(s => s.FirstName)
                .Take(100)
                .ToListAsync();
        }

        // الحصول على طالب بالـ ID
        public async Task<Student?> GetStudentById(int id)
        {
            return await _context.Students.FindAsync(id);
        }

        // إضافة طالب جديد
        public async Task<Student> AddStudent(StudentDTO dto)
        {
            // التحقق من عدم تكرار اسم المستخدم
            if (await _context.Students.AnyAsync(s => s.Username == dto.Username))
                throw new InvalidOperationException("اسم المستخدم موجود بالفعل");

            var student = new Student
            {
                FirstName = dto.FirstName,
                LastName = dto.LastName,
                Username = dto.Username,
                Password = dto.Password, // Reverted to Plain Text
                AdminId = dto.AdminId
            };

            _context.Students.Add(student);
            await _context.SaveChangesAsync();
            return student;
        }

        // تعديل طالب
        public async Task<Student?> UpdateStudent(int id, StudentDTO dto)
        {
            var student = await _context.Students.FirstOrDefaultAsync(s => s.StudentId == id);
            if (student == null) return null;

            student.FirstName = dto.FirstName;
            student.LastName = dto.LastName;
            student.Username = dto.Username;
            student.Password = dto.Password; // Reverted to Plain Text

            await _context.SaveChangesAsync();
            return student;
        }

        // حذف طالب (مع حذف كل بياناته المرتبطة)
        public async Task<bool> DeleteStudent(int id)
        {
            var student = await _context.Students
                .Include(s => s.Evaluations)
                .Include(s => s.StudentSubjects)
                .FirstOrDefaultAsync(s => s.StudentId == id);

            if (student == null) return false;

            // Manual Cascade Delete
            if (student.Evaluations.Any())
                _context.Evaluations.RemoveRange(student.Evaluations);

            if (student.StudentSubjects.Any())
                _context.StudentSubjects.RemoveRange(student.StudentSubjects);

            _context.Students.Remove(student);
            await _context.SaveChangesAsync();
            return true;
        }
    }
}


================
File: StudentSubjectService.cs
Path: Services\StudentSubjectService.cs
================
using Microsoft.EntityFrameworkCore;
using ProfRate.Data;
using ProfRate.DTOs;
using ProfRate.Entities;

namespace ProfRate.Services
{
    // Service للـ StudentSubjects - إدارة ربط الطلاب بالمواد
    public class StudentSubjectService
    {
        private readonly AppDbContext _context;

        public StudentSubjectService(AppDbContext context)
        {
            _context = context;
        }

        // الحصول على كل الارتباطات
        public async Task<List<StudentSubject>> GetAll()
        {
            return await _context.StudentSubjects
                .Include(ss => ss.Student)
                .Include(ss => ss.Subject)
                .Include(ss => ss.Lecturer)
                .ToListAsync();
        }

        // الحصول على مواد طالب معين
        public async Task<List<StudentSubject>> GetByStudent(int studentId)
        {
            return await _context.StudentSubjects
                .Where(ss => ss.StudentId == studentId)
                .Include(ss => ss.Subject)
                .Include(ss => ss.Lecturer)
                .ToListAsync();
        }

        // إضافة ربط جديد
        public async Task<(bool Success, string Message)> AddStudentSubject(StudentSubjectDTO dto)
        {
            // التحقق من عدم التكرار (نفس الطالب والمادة)
            var exists = await _context.StudentSubjects
                .AnyAsync(ss => ss.StudentId == dto.StudentId && ss.SubjectId == dto.SubjectId);

            if (exists)
            {
                return (false, "هذا الطالب مسجل بالفعل في هذه المادة (لا يمكن تسجيل المادة مرتين)");
            }

            var entry = new StudentSubject
            {
                StudentId = dto.StudentId,
                SubjectId = dto.SubjectId,
                LecturerId = dto.LecturerId
            };

            _context.StudentSubjects.Add(entry);
            await _context.SaveChangesAsync();
            return (true, "تم ربط الطالب بالمادة بنجاح");
        }

        // تعديل ربط
        public async Task<(bool Success, string Message)> UpdateStudentSubject(int id, StudentSubjectDTO dto)
        {
            var entry = await _context.StudentSubjects.FindAsync(id);
            if (entry == null) return (false, "هذا السجل غير موجود");

            // التحقق من عدم التكرار (لو غيرنا الطالب أو المادة)
            bool exists = await _context.StudentSubjects
                .AnyAsync(ss => ss.StudentId == dto.StudentId && ss.SubjectId == dto.SubjectId && ss.StudentSubjectId != id);

            if (exists)
            {
                return (false, "هذا الطالب مسجل بالفعل في هذه المادة");
            }

            entry.StudentId = dto.StudentId;
            entry.SubjectId = dto.SubjectId;
            entry.LecturerId = dto.LecturerId;

            await _context.SaveChangesAsync();
            return (true, "تم تعديل الربط بنجاح");
        }

        // حذف ربط
        public async Task<bool> DeleteStudentSubject(int id)
        {
            var entry = await _context.StudentSubjects.FindAsync(id);
            if (entry == null) return false;

            _context.StudentSubjects.Remove(entry);
            await _context.SaveChangesAsync();
            return true;
        }
    }
}


================
File: SubjectService.cs
Path: Services\SubjectService.cs
================
using Microsoft.EntityFrameworkCore;
using ProfRate.Data;
using ProfRate.DTOs;
using ProfRate.Entities;

namespace ProfRate.Services
{
    // Service للـ Subjects - إدارة المواد
    public class SubjectService
    {
        private readonly AppDbContext _context;

        public SubjectService(AppDbContext context)
        {
            _context = context;
        }

        // الحصول على كل المواد
        public async Task<List<Subject>> GetAllSubjects()
        {
            return await _context.Subjects.AsNoTracking().ToListAsync();
        }

        // الحصول على مادة بالـ ID
        public async Task<Subject?> GetSubjectById(int id)
        {
            return await _context.Subjects.FindAsync(id);
        }

        // إضافة مادة جديدة
        public async Task<Subject?> AddSubject(SubjectDTO dto)
        {
            // التحقق من عدم وجود مادة بنفس الاسم
            var existingSubject = await _context.Subjects
                .AsNoTracking()
                .FirstOrDefaultAsync(s => s.SubjectName.ToLower() == dto.SubjectName.ToLower());
            
            if (existingSubject != null)
            {
                return null; // المادة موجودة مسبقاً
            }

            var subject = new Subject
            {
                SubjectName = dto.SubjectName
            };

            _context.Subjects.Add(subject);
            await _context.SaveChangesAsync();
            return subject;
        }



        // حذف مادة
        // حذف مادة (مع حذف كل بياناتها المرتبطة)
        public async Task<bool> DeleteSubject(int id)
        {
            var subject = await _context.Subjects
                .Include(s => s.Evaluations)
                .Include(s => s.StudentSubjects)
                .Include(s => s.LecturerSubjects)
                .FirstOrDefaultAsync(s => s.SubjectId == id);

            if (subject == null) return false;

            // Manual Cascade Delete
            if (subject.Evaluations.Any())
                _context.Evaluations.RemoveRange(subject.Evaluations);

            if (subject.StudentSubjects.Any())
                _context.StudentSubjects.RemoveRange(subject.StudentSubjects);

            if (subject.LecturerSubjects.Any())
                _context.LecturerSubjects.RemoveRange(subject.LecturerSubjects);

            _context.Subjects.Remove(subject);
            await _context.SaveChangesAsync();
            return true;
        }
    }
}


================
File: Program.cs
Path: Program.cs
================
using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.AspNetCore.RateLimiting;
using Microsoft.EntityFrameworkCore;
using Microsoft.IdentityModel.Tokens;
using ProfRate.Data;
using ProfRate.Services;
using System.Text;

var builder = WebApplication.CreateBuilder(args);

// ===== إضافة الـ Services =====

// 1. إضافة الـ Controllers with JSON options
builder.Services.AddControllers()
    .AddJsonOptions(options =>
    {
        options.JsonSerializerOptions.ReferenceHandler = System.Text.Json.Serialization.ReferenceHandler.IgnoreCycles;
    });

// 2. إضافة الـ Swagger
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

// 3. إضافة الـ Database Connection
builder.Services.AddDbContext<AppDbContext>(options =>
    options.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection")));

// 4. إضافة الـ Services (Dependency Injection)
builder.Services.AddScoped<AuthService>();
builder.Services.AddScoped<StudentService>();
builder.Services.AddScoped<LecturerService>();
builder.Services.AddScoped<EvaluationService>();
builder.Services.AddScoped<QuestionService>();
builder.Services.AddScoped<SubjectService>();
builder.Services.AddScoped<StudentSubjectService>();
builder.Services.AddScoped<LecturerSubjectService>();

// 5. إضافة الـ JWT Authentication
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options =>
    {
        options.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateIssuer = true,
            ValidateAudience = true,
            ValidateLifetime = true,
            ValidateIssuerSigningKey = true,
            ValidIssuer = builder.Configuration["Jwt:Issuer"],
            ValidAudience = builder.Configuration["Jwt:Audience"],
            IssuerSigningKey = new SymmetricSecurityKey(
                Encoding.UTF8.GetBytes(builder.Configuration["Jwt:Key"]!))
        };
    });

// 6. إضافة الـ CORS
var allowedOrigins = builder.Configuration.GetSection("AllowedOrigins").Get<string[]>() ?? new[] { "*" };
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowSpecificOrigins", policy =>
    {
        if (allowedOrigins.Contains("*"))
        {
             policy.AllowAnyOrigin().AllowAnyMethod().AllowAnyHeader();
        }
        else 
        {
             policy.WithOrigins(allowedOrigins).AllowAnyMethod().AllowAnyHeader().AllowCredentials();
        }
    });
});

// 7. إضافة Memory Cache (للأداء)
builder.Services.AddMemoryCache();

// 8. إضافة Rate Limiting (للحماية من الهجمات)
builder.Services.AddRateLimiter(options =>
{
    // General Policy
    options.AddFixedWindowLimiter("general", opt =>
    {
        opt.PermitLimit = 30;
        opt.Window = TimeSpan.FromMinutes(1);
        opt.QueueProcessingOrder = System.Threading.RateLimiting.QueueProcessingOrder.OldestFirst;
        opt.QueueLimit = 2;
    });

    // Strict Login Policy
    options.AddFixedWindowLimiter("login", opt =>
    {
        opt.PermitLimit = 5;
        opt.Window = TimeSpan.FromMinutes(5);
        opt.QueueProcessingOrder = System.Threading.RateLimiting.QueueProcessingOrder.OldestFirst;
        opt.QueueLimit = 0;
    });
});

var app = builder.Build();

// ===== Database Seeding - إنشاء Admin افتراضي =====
using (var scope = app.Services.CreateScope())
{
    var context = scope.ServiceProvider.GetRequiredService<AppDbContext>();
    
    // إنشاء أو تحديث Admin افتراضي
    var existingAdmin = context.Admins.FirstOrDefault(a => a.Username == "admin");
    if (existingAdmin == null)
    {
        context.Admins.Add(new ProfRate.Entities.Admin
        {
            Username = "admin",
            Password = "admin123",
            FirstName = "System",
            LastName = "Admin"
        });
        context.SaveChanges();
        Console.WriteLine("✅ تم إنشاء Admin افتراضي: admin / admin123");
    }
    else
    {
        // تحديث البيانات لو ناقصة
        bool updated = false;
        if (existingAdmin.Password != "admin123")
        {
            existingAdmin.Password = "admin123";
            updated = true;
        }
        if (string.IsNullOrEmpty(existingAdmin.FirstName))
        {
            existingAdmin.FirstName = "System";
            updated = true;
        }
        if (string.IsNullOrEmpty(existingAdmin.LastName))
        {
            existingAdmin.LastName = "Admin";
            updated = true;
        }
        if (updated)
        {
            context.SaveChanges();
            Console.WriteLine("✅ تم تحديث Admin: admin / admin123");
        }
    }
}

// ===== Configure the HTTP request pipeline =====
app.UseMiddleware<ProfRate.Middleware.ExceptionMiddleware>();

// Swagger (للتطوير فقط)
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

// Static Files - لتقديم الـ Frontend
app.UseDefaultFiles();
app.UseStaticFiles();

// HTTPS Redirection
// app.UseHttpsRedirection();

// CORS
app.UseCors("AllowSpecificOrigins");

// Rate Limiter
app.UseRateLimiter();

// Authentication & Authorization
app.UseAuthentication();
app.UseAuthorization();

// Map Controllers
app.MapControllers();

// Redirect root to frontend
app.MapGet("/", () => Results.Redirect("/frontend/login.html"));
app.MapGet("/login.html", () => Results.Redirect("/frontend/login.html"));

// تشغيل التطبيق
app.Run();


================
File: appsettings.json
Path: appsettings.json
================
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "ConnectionStrings": {
    "DefaultConnection": "Server=.;Database=ProfRateDB;User Id=sa;Password=123456;TrustServerCertificate=True;"
  },
  "Jwt": {
    "Key": "ProfRateSecretKey123456789012345678901234",
    "Issuer": "ProfRateAPI",
    "Audience": "ProfRateUsers"
  }
}

================
File: login.html
Path: wwwroot\frontend\login.html
================
<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProfRate - تسجيل الدخول</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1><i class="fas fa-graduation-cap"></i> ProfRate</h1>
                <p>نظام تقييم المحاضرين</p>
            </div>

            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">اسم المستخدم</label>
                    <input type="text" class="form-control" id="username" required placeholder="أدخل اسم المستخدم">
                </div>

                <div class="form-group">
                    <label class="form-label">كلمة المرور</label>
                    <input type="password" class="form-control" id="password" required placeholder="أدخل كلمة المرور">
                </div>

                <div class="form-group">
                    <label class="form-label">نوع المستخدم</label>
                    <select class="form-control" id="userType" required>
                        <option value="">اختر نوع المستخدم</option>
                        <option value="Admin">أدمن</option>
                        <option value="Student">طالب</option>
                        <option value="Lecturer">محاضر</option>
                    </select>
                </div>

                <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-sign-in-alt"></i>
                    تسجيل الدخول
                </button>
            </form>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        document.getElementById('loginForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const userType = document.getElementById('userType').value;
            const errorDiv = document.getElementById('errorMessage');

            // إخفاء رسالة الخطأ
            errorDiv.style.display = 'none';

            // إرسال طلب تسجيل الدخول
            const result = await AuthAPI.login(username, password, userType);

            if (result.success && result.data.success) {
                // حفظ الـ Token
                localStorage.setItem('token', result.data.token);
                localStorage.setItem('userType', result.data.userType);
                localStorage.setItem('userId', result.data.userId);
                localStorage.setItem('firstName', result.data.firstName || '');
                localStorage.setItem('fullName', result.data.fullName || result.data.firstName || '');

                // التوجيه للصفحة المناسبة
                if (userType === 'Admin') {
                    window.location.href = 'pages/dashboard.html';
                } else if (userType === 'Student') {
                    window.location.href = 'pages/student-dashboard.html';
                } else {
                    window.location.href = 'pages/lecturer-dashboard.html';
                }
            } else {
                // عرض رسالة الخطأ
                errorDiv.textContent = result.data.message || 'خطأ في تسجيل الدخول';
                errorDiv.style.display = 'block';
            }
        });
    </script>
</body>

</html>

================
File: dashboard.html
Path: wwwroot\frontend\pages\dashboard.html
================
<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProfRate - لوحة التحكم</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-graduation-cap"></i> ProfRate</h1>
                <p>نظام تقييم المحاضرين</p>
            </div>

            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="dashboard.html" class="nav-link active">
                        <i class="fas fa-home"></i>
                        <span>لوحة التحكم</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="students.html" class="nav-link">
                        <i class="fas fa-user-graduate"></i>
                        <span>إدارة الطلاب</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="lecturers.html" class="nav-link">
                        <i class="fas fa-chalkboard-teacher"></i>
                        <span>إدارة المحاضرين</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="subjects.html" class="nav-link">
                        <i class="fas fa-book"></i>
                        <span>إدارة المواد</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="questions.html" class="nav-link">
                        <i class="fas fa-question-circle"></i>
                        <span>إدارة الأسئلة</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="assign-students.html" class="nav-link">
                        <i class="fas fa-user-plus"></i>
                        <span>ربط الطلاب بالمواد</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="assign-lecturers.html" class="nav-link">
                        <i class="fas fa-chalkboard-user"></i>
                        <span>ربط المحاضرين بالمواد</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="reports.html" class="nav-link">
                        <i class="fas fa-chart-bar"></i>
                        <span>التقارير</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>تسجيل الخروج</span>
                    </a>
                </li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h2 class="page-title">لوحة التحكم</h2>
                <h2 id="welcomeMessage" style="margin: 0;">مرحباً بك</h2>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="studentsCount">0</div>
                    <div class="stat-label">الطلاب</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-number" id="lecturersCount">0</div>
                    <div class="stat-label">المحاضرين</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-number" id="subjectsCount">0</div>
                    <div class="stat-label">المواد</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-number" id="evaluationsCount">0</div>
                    <div class="stat-label">التقييمات</div>
                </div>
            </div>

            <!-- Actions -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 class="card-title">إجراءات سريعة</h3>
                </div>
                <div style="padding: 20px;">
                    <button onclick="resetEvaluations()" class="btn btn-danger">
                        <i class="fas fa-redo-alt"></i> بدء دورة تقييم جديدة (أرشفة الحالي)
                    </button>
                </div>
            </div>

            <!-- Recent Evaluations -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">آخر التقييمات</h3>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>المحاضر</th>
                                <th>المادة</th>
                                <th>التقييم</th>
                            </tr>
                        </thead>
                        <tbody id="recentEvaluations">
                            <tr>
                                <td colspan="4" style="text-align: center;">جاري التحميل...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="../js/api.js"></script>
    <script>
        // التحقق من تسجيل الدخول
        checkAuth();

        // عرض اسم المستخدم
        const fullName = localStorage.getItem('fullName');
        const firstName = localStorage.getItem('firstName');
        if (fullName && fullName !== 'null' && fullName !== 'undefined' && fullName !== '') {
            document.getElementById('welcomeMessage').textContent = 'مرحباً: ' + fullName;
        } else if (firstName && firstName !== 'null' && firstName !== 'undefined' && firstName !== '') {
            document.getElementById('welcomeMessage').textContent = 'مرحباً: ' + firstName;
        }

        // تحميل الإحصائيات
        async function loadStats() {
            // عدد الطلاب
            const students = await StudentsAPI.getAll();
            if (students.success) {
                // Students returns PagedResult, so check totalCount
                document.getElementById('studentsCount').textContent = students.data.totalCount || 0;
            }

            // عدد المحاضرين
            const lecturers = await LecturersAPI.getAll();
            if (lecturers.success) {
                document.getElementById('lecturersCount').textContent = lecturers.data.length;
            }

            // عدد المواد
            const subjects = await SubjectsAPI.getAll();
            if (subjects.success) {
                document.getElementById('subjectsCount').textContent = subjects.data.length;
            }

            // عدد التقييمات
            const evaluations = await EvaluationsAPI.getAll();
            if (evaluations.success) {
                document.getElementById('evaluationsCount').textContent = evaluations.data.length;
                loadRecentEvaluations(evaluations.data);
            }
        }

        // تحميل آخر التقييمات
        function loadRecentEvaluations(evaluations) {
            const tbody = document.getElementById('recentEvaluations');

            if (evaluations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">لا توجد تقييمات</td></tr>';
                return;
            }

            const recent = evaluations.slice(-5).reverse();
            tbody.innerHTML = recent.map((e, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>${e.lecturerName || ''}</td>
                    <td>${e.subjectName || ''}</td>
                    <td>${'★'.repeat(e.rating)}${'☆'.repeat(5 - e.rating)}</td>
                </tr>
            `).join('');
        }

        // بدء التحميل
        async function resetEvaluations() {
            if (confirm('هل أنت متأكد من بدء دورة تقييم جديدة؟ سيتم أرشفة جميع التقييمات الحالية ولن تظهر في التقارير المباشرة.')) {
                const result = await apiCall('/evaluations/Reset', 'POST');
                if (result.success) {
                    showAlert(result.data.message);
                } else {
                    showAlert('حدث خطأ أثناء إعادة الضبط', 'danger');
                }
            }
        }

        loadStats();
    </script>
</body>

</html>

================
File: student-dashboard.html
Path: wwwroot\frontend\pages\student-dashboard.html
================
<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProfRate - الطالب</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-graduation-cap"></i> ProfRate</h1>
                <p>نظام تقييم المحاضرين</p>
            </div>
            <ul class="nav-menu">
                <li class="nav-item"><a href="student-dashboard.html" class="nav-link active"><i
                            class="fas fa-home"></i><span>الرئيسية</span></a></li>
                <li class="nav-item"><a href="evaluate.html" class="nav-link"><i class="fas fa-star"></i><span>تقييم
                            المحاضرين</span></a></li>
                <li class="nav-item"><a href="view-ratings.html" class="nav-link"><i class="fas fa-eye"></i><span>عرض
                            التقييمات</span></a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="logout()"><i
                            class="fas fa-sign-out-alt"></i><span>تسجيل الخروج</span></a></li>
            </ul>
        </aside>

        <main class="main-content">
            <div class="page-header">
                <h2 class="page-title">مرحباً بك</h2>
                <span id="welcomeMessage"></span>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="myEvaluations">0</div>
                    <div class="stat-label">تقييماتي</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-number" id="totalLecturers">0</div>
                    <div class="stat-label">المحاضرين</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">الإجراءات المتاحة</h3>
                </div>
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <a href="evaluate.html" class="btn btn-primary" style="text-decoration: none;">
                        <i class="fas fa-star"></i> تقييم المحاضرين
                    </a>
                    <a href="view-ratings.html" class="btn btn-success" style="text-decoration: none;">
                        <i class="fas fa-eye"></i> عرض تقييمات المحاضرين
                    </a>
                </div>
            </div>
        </main>
    </div>

    <script src="../js/api.js"></script>
    <script>
        checkAuth();

        // عرض اسم المستخدم
        const fullName = localStorage.getItem('fullName');
        if (fullName && fullName !== 'null' && fullName !== 'undefined' && fullName !== '') {
            document.querySelector('.page-title').textContent = 'مرحباً: ' + fullName;
        }

        async function loadStats() {
            const lecturers = await LecturersAPI.getAll();
            if (lecturers.success) {
                document.getElementById('totalLecturers').textContent = lecturers.data.length;
            }

            const evaluations = await EvaluationsAPI.getAll();
            if (evaluations.success) {
                const studentId = localStorage.getItem('userId');
                const myEvals = evaluations.data.filter(e => e.studentId == studentId);
                document.getElementById('myEvaluations').textContent = myEvals.length;
            }
        }

        loadStats();
    </script>
</body>

</html>

================
File: lecturer-dashboard.html
Path: wwwroot\frontend\pages\lecturer-dashboard.html
================
<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProfRate - تقييماتي</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-graduation-cap"></i> ProfRate</h1>
                <p>نظام تقييم المحاضرين</p>
            </div>
            <ul class="nav-menu">
                <li class="nav-item"><a href="lecturer-dashboard.html" class="nav-link active"><i
                            class="fas fa-chart-line"></i><span>تقييماتي</span></a></li>
                <li class="nav-item"><a href="all-ratings.html" class="nav-link"><i
                            class="fas fa-users"></i><span>تقييمات الجميع</span></a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="logout()"><i
                            class="fas fa-sign-out-alt"></i><span>تسجيل الخروج</span></a></li>
            </ul>
        </aside>

        <main class="main-content">
            <div class="page-header">
                <h2 class="page-title">تقييماتي</h2>
            </div>

            <!-- ملخص التقييمات -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalEvaluations">0</div>
                    <div class="stat-label">إجمالي التقييمات</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-number" id="averageRating">0</div>
                    <div class="stat-label">متوسط التقييم</div>
                </div>
            </div>

            <!-- تفاصيل التقييمات -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">تفاصيل التقييمات (بدون أسماء الطلاب)</h3>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>المادة</th>
                                <th>السؤال</th>
                                <th>التقييم</th>
                            </tr>
                        </thead>
                        <tbody id="evaluationsTable">
                            <tr>
                                <td colspan="4" style="text-align: center;">جاري التحميل...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="../js/api.js"></script>
    <script>
        checkAuth();

        // عرض اسم المستخدم
        const fullName = localStorage.getItem('fullName');
        if (fullName && fullName !== 'null' && fullName !== 'undefined' && fullName !== '') {
            document.querySelector('.page-title').textContent = 'مرحباً: د.' + fullName;
        }

        const lecturerId = localStorage.getItem('userId');

        async function loadMyEvaluations() {
            // جلب تقييمات المحاضر الحالي
            const result = await apiCall(`/evaluations/GetByLecturer/${lecturerId}`);

            if (!result.success || result.data.length === 0) {
                document.getElementById('evaluationsTable').innerHTML =
                    '<tr><td colspan="4" style="text-align: center;">لا توجد تقييمات بعد</td></tr>';
                return;
            }

            const evaluations = result.data;

            // حساب الإحصائيات
            document.getElementById('totalEvaluations').textContent = evaluations.length;
            const avg = evaluations.reduce((sum, e) => sum + e.rating, 0) / evaluations.length;
            document.getElementById('averageRating').textContent = avg.toFixed(1) + ' / 5';

            // عرض التقييمات (بدون اسم الطالب)
            document.getElementById('evaluationsTable').innerHTML = evaluations.map((e, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>${e.subjectName || '-'}</td>
                    <td>${e.questionText || '-'}</td>
                    <td>${'★'.repeat(e.rating)}${'☆'.repeat(5 - e.rating)}</td>
                </tr>
            `).join('');
        }

        loadMyEvaluations();
    </script>
</body>

</html>

================
File: students.html
Path: wwwroot\frontend\pages\students.html
================
<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProfRate - إدارة الطلاب</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-graduation-cap"></i> ProfRate</h1>
                <p>نظام تقييم المحاضرين</p>
            </div>

            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="dashboard.html" class="nav-link">
                        <i class="fas fa-home"></i>
                        <span>لوحة التحكم</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="students.html" class="nav-link active">
                        <i class="fas fa-user-graduate"></i>
                        <span>إدارة الطلاب</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="lecturers.html" class="nav-link">
                        <i class="fas fa-chalkboard-teacher"></i>
                        <span>إدارة المحاضرين</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="subjects.html" class="nav-link">
                        <i class="fas fa-book"></i>
                        <span>إدارة المواد</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="questions.html" class="nav-link">
                        <i class="fas fa-question-circle"></i>
                        <span>إدارة الأسئلة</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="assign-students.html" class="nav-link">
                        <i class="fas fa-user-plus"></i>
                        <span>ربط الطلاب بالمواد</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="assign-lecturers.html" class="nav-link">
                        <i class="fas fa-chalkboard-user"></i>
                        <span>ربط المحاضرين بالمواد</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="reports.html" class="nav-link">
                        <i class="fas fa-chart-bar"></i>
                        <span>التقارير</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>تسجيل الخروج</span>
                    </a>
                </li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">


            <div class="page-header">
                <h2 class="page-title">إدارة الطلاب</h2>
                <button class="btn btn-primary" onclick="openModal()">
                    <i class="fas fa-plus"></i>
                    إضافة طالب
                </button>
            </div>

            <!-- Search Bar -->
            <div class="card" style="margin-bottom: 20px;">
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="searchInput" class="form-control"
                        placeholder="ابحث باسم الطالب أو اسم المستخدم..." onkeyup="searchStudents()">
                </div>
            </div>

            <!-- Students Table -->
            <div class="card">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>الاسم الأول</th>
                                <th>الاسم الأخير</th>
                                <th>اسم المستخدم</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTable">
                            <tr>
                                <td colspan="5" style="text-align: center;">جاري التحميل...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!-- Pagination Controls -->
                <div id="pagination"
                    style="padding: 15px; display: flex; justify-content: center; align-items: center; border-top: 1px solid #eee;">
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Modal -->
    <div class="modal-overlay" id="studentModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">إضافة طالب جديد</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>

            <form id="studentForm">
                <input type="hidden" id="studentId">

                <div class="form-group">
                    <label class="form-label">الاسم الأول</label>
                    <input type="text" class="form-control" id="firstName" required>
                </div>

                <div class="form-group">
                    <label class="form-label">الاسم الأخير</label>
                    <input type="text" class="form-control" id="lastName" required>
                </div>

                <div class="form-group">
                    <label class="form-label">اسم المستخدم</label>
                    <input type="text" class="form-control" id="username" required>
                </div>

                <div class="form-group">
                    <label class="form-label">كلمة المرور</label>
                    <input type="password" class="form-control" id="password" required>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-save"></i>
                    حفظ
                </button>
            </form>
        </div>
    </div>

    <script src="../js/api.js?v=2"></script>
    <script>
        checkAuth();

        let searchTimeout;
        function searchStudents() {
            const query = document.getElementById('searchInput').value;
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => loadStudents(query), 300);
        }

        let currentPage = 1;
        const pageSize = 20;

        // تحميل الطلاب
        async function loadStudents(query = '', page = 1) {
            currentPage = page;
            const result = query ? await StudentsAPI.search(query) : await StudentsAPI.getAll(page, pageSize);
            const tbody = document.getElementById('studentsTable');
            const paginationDiv = document.getElementById('pagination');

            if (!result.success || (query ? result.data.length === 0 : result.data.items.length === 0)) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">لا يوجد طلاب</td></tr>';
                paginationDiv.innerHTML = '';
                return;
            }

            const data = query ? result.data : result.data.items;

            tbody.innerHTML = data.map((s, i) => `
                <tr>
                    <td>${(currentPage - 1) * pageSize + i + 1}</td>
                    <td>${s.firstName}</td>
                    <td>${s.lastName}</td>
                    <td>${s.username}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="editStudent(${s.studentId})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteStudent(${s.studentId})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            // Pagination Controls (Only show if not searching)
            if (!query) {
                const info = result.data;
                paginationDiv.innerHTML = `
                    <button class="btn btn-secondary btn-sm" ${!info.hasPrevious ? 'disabled' : ''} onclick="loadStudents('', ${currentPage - 1})">السابق</button>
                    <span style="margin: 0 10px;">صفحة ${info.currentPage} من ${info.totalPages} (إجمالي: ${info.totalCount})</span>
                    <button class="btn btn-secondary btn-sm" ${!info.hasNext ? 'disabled' : ''} onclick="loadStudents('', ${currentPage + 1})">التالي</button>
                `;
            } else {
                paginationDiv.innerHTML = '';
            }
        }

        // فتح الـ Modal
        function openModal() {
            document.getElementById('studentModal').classList.add('active');
            document.getElementById('modalTitle').textContent = 'إضافة طالب جديد';
            document.getElementById('studentForm').reset();
            document.getElementById('studentId').value = '';
        }

        // إغلاق الـ Modal
        function closeModal() {
            document.getElementById('studentModal').classList.remove('active');
        }

        // تعديل طالب
        async function editStudent(id) {
            const result = await StudentsAPI.getById(id);
            if (result.success) {
                document.getElementById('studentId').value = result.data.studentId;
                document.getElementById('firstName').value = result.data.firstName;
                document.getElementById('lastName').value = result.data.lastName;
                document.getElementById('username').value = result.data.username;
                document.getElementById('password').value = result.data.password;
                document.getElementById('modalTitle').textContent = 'تعديل الطالب';
                document.getElementById('studentModal').classList.add('active');
            }
        }

        // حذف طالب
        async function deleteStudent(id) {
            if (confirm('هل أنت متأكد من حذف هذا الطالب؟')) {
                const result = await StudentsAPI.delete(id);
                if (result.success) {
                    showAlert('تم حذف الطالب بنجاح');
                    loadStudents();
                }
            }
        }

        // التحقق من صحة البيانات
        function validateStudentData(data) {
            const errors = [];
            if (data.firstName.length < 2) errors.push('الاسم الأول يجب أن يكون حرفين على الأقل');
            if (data.lastName.length < 2) errors.push('الاسم الأخير يجب أن يكون حرفين على الأقل');
            if (data.username.length < 3) errors.push('اسم المستخدم يجب أن يكون 3 أحرف على الأقل');
            if (!/^[a-zA-Z0-9_]+$/.test(data.username)) errors.push('اسم المستخدم يجب أن يحتوي على أحرف إنجليزية وأرقام فقط');
            if (data.password.length < 4) errors.push('كلمة المرور يجب أن تكون 4 أحرف على الأقل');
            return errors;
        }

        // حفظ الطالب
        document.getElementById('studentForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const data = {
                firstName: document.getElementById('firstName').value.trim(),
                lastName: document.getElementById('lastName').value.trim(),
                username: document.getElementById('username').value.trim(),
                password: document.getElementById('password').value,
                adminId: parseInt(localStorage.getItem('userId')) || 1
            };

            // Validation Check
            const errors = validateStudentData(data);
            if (errors.length > 0) {
                showAlert(errors.join('\n'), 'danger');
                return;
            }

            const studentId = document.getElementById('studentId').value;
            let result;

            if (studentId) {
                result = await StudentsAPI.update(studentId, data);
            } else {
                result = await StudentsAPI.add(data);
            }

            if (result.success) {
                showAlert(studentId ? 'تم تعديل الطالب بنجاح' : 'تم إضافة الطالب بنجاح');
                closeModal();
                loadStudents();
            } else {
                showAlert(result.data.message || 'حدث خطأ', 'danger');
            }
        });

        loadStudents();
    </script>
</body>

</html>

================
File: lecturers.html
Path: wwwroot\frontend\pages\lecturers.html
================
<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProfRate - إدارة المحاضرين</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-graduation-cap"></i> ProfRate</h1>
                <p>نظام تقييم المحاضرين</p>
            </div>

            <ul class="nav-menu">
                <li class="nav-item"><a href="dashboard.html" class="nav-link"><i class="fas fa-home"></i><span>لوحة
                            التحكم</span></a></li>
                <li class="nav-item"><a href="students.html" class="nav-link"><i
                            class="fas fa-user-graduate"></i><span>إدارة الطلاب</span></a></li>
                <li class="nav-item"><a href="lecturers.html" class="nav-link active"><i
                            class="fas fa-chalkboard-teacher"></i><span>إدارة المحاضرين</span></a></li>
                <li class="nav-item"><a href="subjects.html" class="nav-link"><i class="fas fa-book"></i><span>إدارة
                            المواد</span></a></li>
                <li class="nav-item"><a href="questions.html" class="nav-link"><i
                            class="fas fa-question-circle"></i><span>إدارة الأسئلة</span></a></li>
                <li class="nav-item"><a href="assign-students.html" class="nav-link"><i
                            class="fas fa-user-plus"></i><span>ربط الطلاب بالمواد</span></a></li>
                <li class="nav-item"><a href="assign-lecturers.html" class="nav-link"><i
                            class="fas fa-chalkboard-user"></i><span>ربط المحاضرين بالمواد</span></a></li>
                <li class="nav-item"><a href="reports.html" class="nav-link"><i
                            class="fas fa-chart-bar"></i><span>التقارير</span></a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="logout()"><i
                            class="fas fa-sign-out-alt"></i><span>تسجيل الخروج</span></a></li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">


            <div class="page-header">
                <h2 class="page-title">إدارة المحاضرين</h2>
                <button class="btn btn-primary" onclick="openModal()">
                    <i class="fas fa-plus"></i>
                    إضافة محاضر
                </button>
            </div>




            <!-- Search Bar -->
            <div class="card" style="margin-bottom: 20px;">
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="searchInput" class="form-control"
                        placeholder="ابحث باسم المحاضر أو اسم المستخدم..." onkeyup="searchLecturers()">
                </div>
            </div>

            <div class="card">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>الاسم الأول</th>
                                <th>الاسم الأخير</th>
                                <th>اسم المستخدم</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="lecturersTable">
                            <tr>
                                <td colspan="5" style="text-align: center;">جاري التحميل...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="lecturerModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">إضافة محاضر جديد</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form id="lecturerForm">
                <input type="hidden" id="lecturerId">
                <div class="form-group">
                    <label class="form-label">الاسم الأول</label>
                    <input type="text" class="form-control" id="firstName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">الاسم الأخير</label>
                    <input type="text" class="form-control" id="lastName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">اسم المستخدم</label>
                    <input type="text" class="form-control" id="username" required>
                </div>
                <div class="form-group">
                    <label class="form-label">كلمة المرور</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-save"></i> حفظ
                </button>
            </form>
        </div>
    </div>

    <script src="../js/api.js?v=2"></script>
    <script>
        checkAuth();

        let searchTimeout;
        function searchLecturers() {
            const query = document.getElementById('searchInput').value;
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => loadLecturers(query), 300);
        }

        async function loadLecturers(query = '') {
            const result = query ? await LecturersAPI.search(query) : await LecturersAPI.getAll();
            const tbody = document.getElementById('lecturersTable');

            if (!result.success || result.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">لا يوجد محاضرين</td></tr>';
                return;
            }

            tbody.innerHTML = result.data.map((l, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>${l.firstName}</td>
                    <td>${l.lastName}</td>
                    <td>${l.username}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="editLecturer(${l.lecturerId})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger btn-sm" onclick="deleteLecturer(${l.lecturerId})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function openModal() {
            document.getElementById('lecturerModal').classList.add('active');
            document.getElementById('modalTitle').textContent = 'إضافة محاضر جديد';
            document.getElementById('lecturerForm').reset();
            document.getElementById('lecturerId').value = '';
        }

        function closeModal() {
            document.getElementById('lecturerModal').classList.remove('active');
        }

        async function editLecturer(id) {
            const result = await LecturersAPI.getById(id);
            if (result.success) {
                document.getElementById('lecturerId').value = result.data.lecturerId;
                document.getElementById('firstName').value = result.data.firstName;
                document.getElementById('lastName').value = result.data.lastName;
                document.getElementById('username').value = result.data.username;
                document.getElementById('password').value = result.data.password;
                document.getElementById('modalTitle').textContent = 'تعديل المحاضر';
                document.getElementById('lecturerModal').classList.add('active');
            }
        }

        async function deleteLecturer(id) {
            if (confirm('هل أنت متأكد من حذف هذا المحاضر؟')) {
                const result = await LecturersAPI.delete(id);
                if (result.success) {
                    showAlert('تم حذف المحاضر بنجاح');
                    loadLecturers();
                }
            }
        }

        // التحقق من صحة البيانات
        function validateLecturerData(data) {
            const errors = [];
            if (data.firstName.length < 2) errors.push('الاسم الأول يجب أن يكون حرفين على الأقل');
            if (data.lastName.length < 2) errors.push('الاسم الأخير يجب أن يكون حرفين على الأقل');
            if (data.username.length < 3) errors.push('اسم المستخدم يجب أن يكون 3 أحرف على الأقل');
            if (!/^[a-zA-Z0-9_]+$/.test(data.username)) errors.push('اسم المستخدم يجب أن يحتوي على أحرف إنجليزية وأرقام فقط');
            if (data.password.length < 4) errors.push('كلمة المرور يجب أن تكون 4 أحرف على الأقل');
            return errors;
        }

        document.getElementById('lecturerForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const data = {
                firstName: document.getElementById('firstName').value.trim(),
                lastName: document.getElementById('lastName').value.trim(),
                username: document.getElementById('username').value.trim(),
                password: document.getElementById('password').value,
                adminId: parseInt(localStorage.getItem('userId')) || 1
            };

            // Validation Check
            const errors = validateLecturerData(data);
            if (errors.length > 0) {
                showAlert(errors.join('\n'), 'danger');
                return;
            }

            const lecturerId = document.getElementById('lecturerId').value;
            const result = lecturerId ? await LecturersAPI.update(lecturerId, data) : await LecturersAPI.add(data);
            if (result.success) {
                showAlert(lecturerId ? 'تم تعديل المحاضر بنجاح' : 'تم إضافة المحاضر بنجاح');
                closeModal();
                loadLecturers();
            } else {
                // Show backend error
                showAlert(result.data.message || 'حدث خطأ', 'danger');
            }
        });

        loadLecturers();
    </script>
</body>

</html>

================
File: subjects.html
Path: wwwroot\frontend\pages\subjects.html
================
<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProfRate - إدارة المواد</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-graduation-cap"></i> ProfRate</h1>
                <p>نظام تقييم المحاضرين</p>
            </div>
            <ul class="nav-menu">
                <li class="nav-item"><a href="dashboard.html" class="nav-link"><i class="fas fa-home"></i><span>لوحة
                            التحكم</span></a></li>
                <li class="nav-item"><a href="students.html" class="nav-link"><i
                            class="fas fa-user-graduate"></i><span>إدارة الطلاب</span></a></li>
                <li class="nav-item"><a href="lecturers.html" class="nav-link"><i
                            class="fas fa-chalkboard-teacher"></i><span>إدارة المحاضرين</span></a></li>
                <li class="nav-item"><a href="subjects.html" class="nav-link active"><i
                            class="fas fa-book"></i><span>إدارة المواد</span></a></li>
                <li class="nav-item"><a href="questions.html" class="nav-link"><i
                            class="fas fa-question-circle"></i><span>إدارة الأسئلة</span></a></li>
                <li class="nav-item"><a href="assign-students.html" class="nav-link"><i
                            class="fas fa-user-plus"></i><span>ربط الطلاب بالمواد</span></a></li>
                <li class="nav-item"><a href="assign-lecturers.html" class="nav-link"><i
                            class="fas fa-chalkboard-user"></i><span>ربط المحاضرين بالمواد</span></a></li>
                <li class="nav-item"><a href="reports.html" class="nav-link"><i
                            class="fas fa-chart-bar"></i><span>التقارير</span></a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="logout()"><i
                            class="fas fa-sign-out-alt"></i><span>تسجيل الخروج</span></a></li>
            </ul>
        </aside>

        <main class="main-content">
            <div class="page-header">
                <h2 class="page-title">إدارة المواد</h2>
                <button class="btn btn-primary" onclick="openModal()"><i class="fas fa-plus"></i> إضافة مادة</button>
            </div>

            <div class="card">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>اسم المادة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="subjectsTable">
                            <tr>
                                <td colspan="3" style="text-align: center;">جاري التحميل...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="subjectModal">
        <div class="modal">
            <div class="modal-header">
                <h3>إضافة مادة جديدة</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form id="subjectForm">
                <input type="hidden" id="subjectId">
                <div class="form-group">
                    <label class="form-label">اسم المادة</label>
                    <input type="text" class="form-control" id="subjectName" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;"><i class="fas fa-save"></i>
                    حفظ</button>
            </form>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script>
        checkAuth();

        async function loadSubjects() {
            const result = await SubjectsAPI.getAll();
            const tbody = document.getElementById('subjectsTable');
            if (!result.success || result.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">لا توجد مواد</td></tr>';
                return;
            }
            tbody.innerHTML = result.data.map((s, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>${s.subjectName}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteSubject(${s.subjectId})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function openModal() { document.getElementById('subjectModal').classList.add('active'); }
        function closeModal() { document.getElementById('subjectModal').classList.remove('active'); }

        async function deleteSubject(id) {
            if (confirm('هل أنت متأكد من حذف هذه المادة؟')) {
                await SubjectsAPI.delete(id);
                showAlert('تم حذف المادة بنجاح');
                loadSubjects();
            }
        }

        document.getElementById('subjectForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const result = await SubjectsAPI.add({ subjectName: document.getElementById('subjectName').value });
            if (result.success) {
                showAlert('تم إضافة المادة بنجاح');
                closeModal();
                document.getElementById('subjectForm').reset();
                loadSubjects();
            } else {
                showAlert(result.data.message || 'حدث خطأ أثناء إضافة المادة', 'danger');
            }
        });

        loadSubjects();
    </script>
</body>

</html>

================
File: questions.html
Path: wwwroot\frontend\pages\questions.html
================
<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProfRate - إدارة الأسئلة</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-graduation-cap"></i> ProfRate</h1>
                <p>نظام تقييم المحاضرين</p>
            </div>
            <ul class="nav-menu">
                <li class="nav-item"><a href="dashboard.html" class="nav-link"><i class="fas fa-home"></i><span>لوحة
                            التحكم</span></a></li>
                <li class="nav-item"><a href="students.html" class="nav-link"><i
                            class="fas fa-user-graduate"></i><span>إدارة الطلاب</span></a></li>
                <li class="nav-item"><a href="lecturers.html" class="nav-link"><i
                            class="fas fa-chalkboard-teacher"></i><span>إدارة المحاضرين</span></a></li>
                <li class="nav-item"><a href="subjects.html" class="nav-link"><i class="fas fa-book"></i><span>إدارة
                            المواد</span></a></li>
                <li class="nav-item"><a href="questions.html" class="nav-link active"><i
                            class="fas fa-question-circle"></i><span>إدارة الأسئلة</span></a></li>
                <li class="nav-item"><a href="assign-students.html" class="nav-link"><i
                            class="fas fa-user-plus"></i><span>ربط الطلاب بالمواد</span></a></li>
                <li class="nav-item"><a href="assign-lecturers.html" class="nav-link"><i
                            class="fas fa-chalkboard-user"></i><span>ربط المحاضرين بالمواد</span></a></li>
                <li class="nav-item"><a href="reports.html" class="nav-link"><i
                            class="fas fa-chart-bar"></i><span>التقارير</span></a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="logout()"><i
                            class="fas fa-sign-out-alt"></i><span>تسجيل الخروج</span></a></li>
            </ul>
        </aside>

        <main class="main-content">
            <div class="page-header">
                <h2 class="page-title">إدارة الأسئلة</h2>
                <button class="btn btn-primary" onclick="openModal()"><i class="fas fa-plus"></i> إضافة سؤال</button>
            </div>

            <div class="card">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>نص السؤال</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="questionsTable">
                            <tr>
                                <td colspan="3" style="text-align: center;">جاري التحميل...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="questionModal">
        <div class="modal">
            <div class="modal-header">
                <h3>إضافة سؤال جديد</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form id="questionForm">
                <input type="hidden" id="questionId">
                <div class="form-group">
                    <label class="form-label">نص السؤال</label>
                    <textarea class="form-control" id="questionText" rows="3" required
                        placeholder="مثال: كيف تقيم أداء المحاضر؟"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;"><i class="fas fa-save"></i>
                    حفظ</button>
            </form>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script>
        checkAuth();

        let allQuestions = [];

        async function loadQuestions() {
            const result = await QuestionsAPI.getAll();
            const tbody = document.getElementById('questionsTable');
            if (!result.success || result.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">لا توجد أسئلة</td></tr>';
                return;
            }
            allQuestions = result.data;
            tbody.innerHTML = result.data.map((q, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>${q.questionText}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="editQuestion(${q.questionId})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger btn-sm" onclick="deleteQuestion(${q.questionId})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function openModal() {
            document.getElementById('questionModal').classList.add('active');
            document.getElementById('questionForm').reset();
            document.getElementById('questionId').value = '';
            document.querySelector('.modal-header h3').textContent = 'إضافة سؤال جديد';
        }

        function closeModal() { document.getElementById('questionModal').classList.remove('active'); }

        function editQuestion(id) {
            const question = allQuestions.find(q => q.questionId === id);
            if (question) {
                document.getElementById('questionId').value = question.questionId;
                document.getElementById('questionText').value = question.questionText;
                document.querySelector('.modal-header h3').textContent = 'تعديل السؤال';
                document.getElementById('questionModal').classList.add('active');
            }
        }

        async function deleteQuestion(id) {
            if (confirm('هل أنت متأكد من حذف هذا السؤال؟')) {
                await QuestionsAPI.delete(id);
                showAlert('تم حذف السؤال بنجاح');
                loadQuestions();
            }
        }

        document.getElementById('questionForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const id = document.getElementById('questionId').value;
            const text = document.getElementById('questionText').value;

            let result;
            if (id) {
                result = await QuestionsAPI.update(id, { questionText: text, adminId: parseInt(localStorage.getItem('userId')) || 1, questionId: parseInt(id) });
            } else {
                result = await QuestionsAPI.add({ questionText: text, adminId: parseInt(localStorage.getItem('userId')) || 1 });
            }

            if (result.success) {
                showAlert(id ? 'تم تعديل السؤال بنجاح' : 'تم إضافة السؤال بنجاح');
                closeModal();
                loadQuestions();
            } else {
                showAlert('حدث خطأ', 'danger');
            }
        });

        loadQuestions();
    </script>
</body>

</html>

================
File: assign-students.html
Path: wwwroot\frontend\pages\assign-students.html
================
<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProfRate - ربط الطلاب بالمواد</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .search-results {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .search-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .search-item:hover {
            background-color: #f8f9fa;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-graduation-cap"></i> ProfRate</h1>
                <p>نظام تقييم المحاضرين</p>
            </div>
            <ul class="nav-menu">
                <li class="nav-item"><a href="dashboard.html" class="nav-link"><i class="fas fa-home"></i><span>لوحة
                            التحكم</span></a></li>
                <li class="nav-item"><a href="students.html" class="nav-link"><i
                            class="fas fa-user-graduate"></i><span>إدارة الطلاب</span></a></li>
                <li class="nav-item"><a href="lecturers.html" class="nav-link"><i
                            class="fas fa-chalkboard-teacher"></i><span>إدارة المحاضرين</span></a></li>
                <li class="nav-item"><a href="subjects.html" class="nav-link"><i class="fas fa-book"></i><span>إدارة
                            المواد</span></a></li>
                <li class="nav-item"><a href="questions.html" class="nav-link"><i
                            class="fas fa-question-circle"></i><span>إدارة الأسئلة</span></a></li>
                <li class="nav-item"><a href="assign-students.html" class="nav-link active"><i
                            class="fas fa-link"></i><span>ربط الطلاب بالمواد</span></a></li>
                <li class="nav-item"><a href="assign-lecturers.html" class="nav-link"><i
                            class="fas fa-link"></i><span>ربط المحاضرين بالمواد</span></a></li>
                <li class="nav-item"><a href="reports.html" class="nav-link"><i
                            class="fas fa-chart-bar"></i><span>التقارير</span></a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="logout()"><i
                            class="fas fa-sign-out-alt"></i><span>تسجيل الخروج</span></a></li>
            </ul>
        </aside>

        <main class="main-content">
            <div class="page-header">
                <h2 class="page-title">ربط الطلاب بالمواد والمحاضرين</h2>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">تسجيل طالب في مادة مع محاضر محدد</h3>
                </div>
                <form id="assignForm">
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <div class="form-group" style="flex: 1; position: relative;">
                            <label class="form-label">الخطوة 1: ابحث واختر الطالب</label>
                            <input type="hidden" id="selectedStudentId">
                            <input type="text" class="form-control" id="studentSearch"
                                placeholder="اكتب اسم الطالب للبحث..." autocomplete="off">
                            <div id="studentResults" class="search-results"></div>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">الخطوة 2: اختر المادة</label>
                            <select class="form-control" id="subjectId" required>
                                <option value="">اختر المادة</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">الخطوة 3: اختر المحاضر</label>
                            <select class="form-control" id="lecturerId" required disabled>
                                <option value="">اختر المادة أولاً</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i> ربط الطالب بالمادة والمحاضر
                    </button>
                </form>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">الطلاب المسجلين في المواد</h3>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>الطالب</th>
                                <th>المادة</th>
                                <th>المحاضر</th>
                                <th>إجراء</th>
                            </tr>
                        </thead>
                        <tbody id="assignmentsTable">
                            <tr>
                                <td colspan="5" style="text-align: center;">جاري التحميل...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Edit Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-header">
                <h3>تعديل تعيين الطالب</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="editForm">
                <input type="hidden" id="editId">
                <input type="hidden" id="editStudentId">
                <div class="form-group">
                    <label class="form-label">الطالب (للاطلاع فقط)</label>
                    <input type="text" class="form-control" id="editStudentName" readonly disabled>
                </div>
                <div class="form-group">
                    <label class="form-label">المادة</label>
                    <select class="form-control" id="editSubjectId" required>
                        <option value="">اختر المادة</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">المحاضر</label>
                    <select class="form-control" id="editLecturerId" required>
                        <option value="">اختر المحاضر</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-save"></i> حفظ التعديلات
                </button>
            </form>
        </div>
    </div>

    <script src="../js/api.js?v=2"></script>
    <script>
        checkAuth();

        let allAssignments = [];

        async function loadData() {
            // Setup Search for Student
            setupSearchDropdown('studentSearch', 'studentResults', StudentsAPI.search, (id) => {
                document.getElementById('selectedStudentId').value = id;
            });

            const subjects = await SubjectsAPI.getAll();
            if (subjects.success) {
                const select = document.getElementById('subjectId');
                const editSelect = document.getElementById('editSubjectId');
                subjects.data.forEach(s => {
                    const opt = `<option value="${s.subjectId}">${s.subjectName}</option>`;
                    select.innerHTML += opt;
                    editSelect.innerHTML += opt;
                });
            }

            loadAssignments();
        }

        // عند تغيير المادة (Form الرئيسي)
        document.getElementById('subjectId').addEventListener('change', async function () {
            await loadLecturersForSubject(this.value, 'lecturerId');
        });

        // عند تغيير المادة (Form التعديل)
        document.getElementById('editSubjectId').addEventListener('change', async function () {
            await loadLecturersForSubject(this.value, 'editLecturerId');
        });

        async function loadLecturersForSubject(subjectId, targetSelectId) {
            const lecturerSelect = document.getElementById(targetSelectId);

            if (!subjectId) {
                lecturerSelect.innerHTML = '<option value="">اختر المادة أولاً</option>';
                lecturerSelect.disabled = true;
                return;
            }

            const lecturers = await apiCall(`/lecturersubjects/GetBySubject/${subjectId}`);
            lecturerSelect.innerHTML = '<option value="">اختر المحاضر</option>';

            if (lecturers.success && lecturers.data.length > 0) {
                lecturers.data.forEach(ls => {
                    lecturerSelect.innerHTML += `<option value="${ls.lecturerId}">${ls.lecturer?.firstName || ''} ${ls.lecturer?.lastName || ''}</option>`;
                });
                lecturerSelect.disabled = false;
            } else {
                lecturerSelect.innerHTML = '<option value="">لا يوجد محاضرين لهذه المادة</option>';
                lecturerSelect.disabled = true;
            }
        }

        async function loadAssignments() {
            const result = await apiCall('/studentsubjects/GetAll');
            const tbody = document.getElementById('assignmentsTable');

            if (!result.success || result.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">لا توجد تعيينات</td></tr>';
                return;
            }

            allAssignments = result.data;

            tbody.innerHTML = result.data.map((a, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>${a.student?.firstName || ''} ${a.student?.lastName || ''}</td>
                    <td>${a.subject?.subjectName || ''}</td>
                    <td>${a.lecturer ? (a.lecturer.firstName + ' ' + a.lecturer.lastName) : '<span style="color:red">غير محدد</span>'}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="editAssignment(${a.studentSubjectId})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteAssignment(${a.studentSubjectId})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        async function editAssignment(id) {
            const assignment = allAssignments.find(a => a.studentSubjectId === id);
            if (!assignment) return;

            document.getElementById('editId').value = assignment.studentSubjectId;
            document.getElementById('editStudentId').value = assignment.studentId;
            document.getElementById('editStudentName').value = `${assignment.student?.firstName} ${assignment.student?.lastName}`;

            // Set Subject
            document.getElementById('editSubjectId').value = assignment.subjectId;

            // Load lecturers then set lecturer
            await loadLecturersForSubject(assignment.subjectId, 'editLecturerId');

            if (assignment.lecturerId) {
                document.getElementById('editLecturerId').value = assignment.lecturerId;
            }

            document.getElementById('editModal').classList.add('active');
        }

        async function deleteAssignment(id) {
            if (confirm('هل أنت متأكد من حذف هذا التعيين؟')) {
                await apiCall(`/studentsubjects/Delete/${id}`, 'DELETE');
                showAlert('تم حذف التعيين بنجاح');
                loadAssignments();
            }
        }

        document.getElementById('assignForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const lecturerId = document.getElementById('lecturerId').value;
            const studentId = document.getElementById('selectedStudentId').value;

            if (!lecturerId || !studentId) {
                showAlert('الرجاء اختيار الطالب والمحاضر', 'danger');
                return;
            }

            const result = await apiCall('/studentsubjects/Add', 'POST', {
                studentId: parseInt(studentId),
                subjectId: parseInt(document.getElementById('subjectId').value),
                lecturerId: parseInt(lecturerId)
            });

            if (result.success) {
                showAlert('تم ربط الطالب بالمادة والمحاضر بنجاح');
                loadAssignments();
            } else {
                showAlert(result.data.message || 'حدث خطأ', 'danger');
            }
        });

        document.getElementById('editForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const id = document.getElementById('editId').value;
            const studentId = document.getElementById('editStudentId').value;
            const subjectId = document.getElementById('editSubjectId').value;
            const lecturerId = document.getElementById('editLecturerId').value;

            if (!lecturerId || !subjectId) {
                showAlert('البيانات ناقصة', 'danger');
                return;
            }

            // Call Update API
            const result = await apiCall(`/studentsubjects/Update/${id}`, 'PUT', {
                studentSubjectId: parseInt(id),
                studentId: parseInt(studentId),
                subjectId: parseInt(subjectId),
                lecturerId: parseInt(lecturerId)
            });

            if (result.success) {
                showAlert('تم تعديل التعيين بنجاح');
                closeEditModal();
                loadAssignments();
            } else {
                showAlert(result.data.message || 'حدث خطأ', 'danger');
            }
        });

        loadData();
    </script>
</body>

</html>

================
File: assign-lecturers.html
Path: wwwroot\frontend\pages\assign-lecturers.html
================
<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProfRate - ربط المحاضرين بالمواد</title>
    <link rel="stylesheet" href="../css/style.css?v=2">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .search-results {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .search-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .search-item:hover {
            background-color: #f8f9fa;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-graduation-cap"></i> ProfRate</h1>
                <p>نظام تقييم المحاضرين</p>
            </div>
            <ul class="nav-menu">
                <li class="nav-item"><a href="dashboard.html" class="nav-link"><i class="fas fa-home"></i><span>لوحة
                            التحكم</span></a></li>
                <li class="nav-item"><a href="students.html" class="nav-link"><i
                            class="fas fa-user-graduate"></i><span>إدارة الطلاب</span></a></li>
                <li class="nav-item"><a href="lecturers.html" class="nav-link"><i
                            class="fas fa-chalkboard-teacher"></i><span>إدارة المحاضرين</span></a></li>
                <li class="nav-item"><a href="subjects.html" class="nav-link"><i class="fas fa-book"></i><span>إدارة
                            المواد</span></a></li>
                <li class="nav-item"><a href="questions.html" class="nav-link"><i
                            class="fas fa-question-circle"></i><span>إدارة الأسئلة</span></a></li>
                <li class="nav-item"><a href="assign-students.html" class="nav-link"><i
                            class="fas fa-link"></i><span>ربط الطلاب بالمواد</span></a></li>
                <li class="nav-item"><a href="assign-lecturers.html" class="nav-link active"><i
                            class="fas fa-link"></i><span>ربط المحاضرين بالمواد</span></a></li>
                <li class="nav-item"><a href="reports.html" class="nav-link"><i
                            class="fas fa-chart-bar"></i><span>التقارير</span></a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="logout()"><i
                            class="fas fa-sign-out-alt"></i><span>تسجيل الخروج</span></a></li>
            </ul>
        </aside>

        <main class="main-content">
            <div class="page-header">
                <h2 class="page-title">ربط المحاضرين بالمواد</h2>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">تعيين محاضر لمادة</h3>
                </div>
                <form id="assignForm">
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <div class="form-group" style="flex: 1; position: relative;">
                            <label class="form-label">المحاضر (بحث)</label>
                            <input type="hidden" id="selectedLecturerId">
                            <input type="text" class="form-control" id="lecturerSearch"
                                placeholder="ابحث باسم المحاضر..." autocomplete="off">
                            <div id="lecturerResults" class="search-results"></div>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">المادة</label>
                            <select class="form-control" id="subjectId" required>
                                <option value="">اختر المادة</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i> ربط المحاضر بالمادة
                    </button>
                </form>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">المحاضرين والمواد المعينة لهم</h3>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>المحاضر</th>
                                <th>المادة</th>
                                <th>إجراء</th>
                            </tr>
                        </thead>
                        <tbody id="assignmentsTable">
                            <tr>
                                <td colspan="4" style="text-align: center;">جاري التحميل...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Edit Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-header">
                <h3>تعديل تعيين المحاضر</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="editForm">
                <input type="hidden" id="editId">
                <input type="hidden" id="editLecturerId">
                <div class="form-group">
                    <label class="form-label">المحاضر (للاطلاع فقط)</label>
                    <input type="text" class="form-control" id="editLecturerName" readonly disabled>
                </div>
                <div class="form-group">
                    <label class="form-label">المادة</label>
                    <select class="form-control" id="editSubjectId" required>
                        <option value="">اختر المادة</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-save"></i> حفظ التعديلات
                </button>
            </form>
        </div>
    </div>

    <script src="../js/api.js?v=2"></script>
    <script>
        checkAuth();

        let allAssignments = [];

        async function loadData() {
            // Setup Search for Lecturer
            setupSearchDropdown('lecturerSearch', 'lecturerResults', LecturersAPI.search, (id) => {
                document.getElementById('selectedLecturerId').value = id;
            });

            const subjects = await SubjectsAPI.getAll();
            if (subjects.success) {
                const select = document.getElementById('subjectId');
                const editSelect = document.getElementById('editSubjectId');
                subjects.data.forEach(s => {
                    const opt = `<option value="${s.subjectId}">${s.subjectName}</option>`;
                    select.innerHTML += opt;
                    editSelect.innerHTML += opt;
                });
            }

            loadAssignments();
        }

        async function loadAssignments() {
            const result = await apiCall('/lecturersubjects/GetAll');
            const tbody = document.getElementById('assignmentsTable');

            if (!result.success || result.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">لا توجد تعيينات</td></tr>';
                return;
            }

            allAssignments = result.data;

            tbody.innerHTML = result.data.map((a, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>${a.lecturer?.firstName || ''} ${a.lecturer?.lastName || ''}</td>
                    <td>${a.subject?.subjectName || ''}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="editAssignment(${a.lecturerSubjectId})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteAssignment(${a.lecturerSubjectId})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        function editAssignment(id) {
            const assignment = allAssignments.find(a => a.lecturerSubjectId === id);
            if (!assignment) return;

            document.getElementById('editId').value = assignment.lecturerSubjectId;
            document.getElementById('editLecturerId').value = assignment.lecturerId;
            document.getElementById('editLecturerName').value = `${assignment.lecturer?.firstName} ${assignment.lecturer?.lastName}`;
            document.getElementById('editSubjectId').value = assignment.subjectId;

            document.getElementById('editModal').classList.add('active');
        }

        async function deleteAssignment(id) {
            if (confirm('هل أنت متأكد من حذف هذا التعيين؟')) {
                await apiCall(`/lecturersubjects/Delete/${id}`, 'DELETE');
                showAlert('تم حذف التعيين بنجاح');
                loadAssignments();
            }
        }

        document.getElementById('assignForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const lecturerId = document.getElementById('selectedLecturerId').value;
            if (!lecturerId) {
                showAlert('الرجاء اختيار المحاضر من البحث', 'danger');
                return;
            }

            const result = await apiCall('/lecturersubjects/Add', 'POST', {
                lecturerId: parseInt(lecturerId),
                subjectId: parseInt(document.getElementById('subjectId').value)
            });
            if (result.success) {
                showAlert('تم ربط المحاضر بالمادة بنجاح');
                loadAssignments();
            } else {
                showAlert(result.data.message || 'حدث خطأ', 'danger');
            }
        });

        document.getElementById('editForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const id = document.getElementById('editId').value;
            const lecturerId = document.getElementById('editLecturerId').value;
            const subjectId = document.getElementById('editSubjectId').value;

            const result = await apiCall(`/lecturersubjects/Update/${id}`, 'PUT', {
                lecturerSubjectId: parseInt(id),
                lecturerId: parseInt(lecturerId),
                subjectId: parseInt(subjectId)
            });

            if (result.success) {
                showAlert('تم تعديل التعيين بنجاح');
                closeEditModal();
                loadAssignments();
            } else {
                showAlert(result.data.message || 'حدث خطأ', 'danger');
            }
        });

        loadData();
    </script>
</body>

</html>

================
File: evaluate.html
Path: wwwroot\frontend\pages\evaluate.html
================
<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProfRate - تقييم المحاضرين</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-graduation-cap"></i> ProfRate</h1>
                <p>نظام تقييم المحاضرين</p>
            </div>
            <ul class="nav-menu">
                <li class="nav-item"><a href="student-dashboard.html" class="nav-link"><i
                            class="fas fa-home"></i><span>الرئيسية</span></a></li>
                <li class="nav-item"><a href="evaluate.html" class="nav-link active"><i
                            class="fas fa-star"></i><span>تقييم المحاضرين</span></a></li>
                <li class="nav-item"><a href="view-ratings.html" class="nav-link"><i class="fas fa-eye"></i><span>عرض
                            التقييمات</span></a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="logout()"><i
                            class="fas fa-sign-out-alt"></i><span>تسجيل الخروج</span></a></li>
            </ul>
        </aside>

        <main class="main-content">
            <div class="page-header">
                <h2 class="page-title">تقييم المحاضرين</h2>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">تقييم المواد المسجلة</h3>
                </div>

                <form id="evaluationForm">
                    <div class="form-group">
                        <label class="form-label">اختر المادة لتقييم محاضرها</label>
                        <select class="form-control" id="subjectSelect" required>
                            <option value="">اختر المادة</option>
                        </select>
                    </div>

                    <div id="lecturerInfo"
                        style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0;">المحاضر: <span id="lecturerName"
                                style="color: var(--primary-color);"></span></h4>
                        <input type="hidden" id="lecturerId">
                        <input type="hidden" id="subjectId">
                    </div>

                    <div id="questionsContainer" style="display: none;">
                        <!-- الأسئلة ستظهر هنا -->
                    </div>

                    <button type="submit" id="submitBtn" class="btn btn-primary"
                        style="width: 100%; margin-top: 20px; display: none;">
                        <i class="fas fa-paper-plane"></i>
                        إرسال التقييم
                    </button>
                </form>
            </div>
        </main>
    </div>

    <script src="../js/api.js"></script>
    <script>
        checkAuth();

        const studentId = localStorage.getItem('userId');
        let questions = [];
        let studentSubjects = [];

        async function loadData() {
            // تحميل المواد المسجل فيها الطالب مع المحاضرين
            const mySubjects = await apiCall(`/studentsubjects/GetByStudent/${studentId}`);
            const subjectSelect = document.getElementById('subjectSelect');

            if (mySubjects.success && mySubjects.data.length > 0) {
                studentSubjects = mySubjects.data;

                // فلتر المواد اللي ملهاش محاضر (لو فيه خطأ قديم)
                const validSubjects = studentSubjects.filter(ss => ss.lecturerId != null);

                if (validSubjects.length === 0) {
                    subjectSelect.innerHTML = '<option value="">لا توجد مواد مسجلة مع محاضرين - تواصل مع الأدمن</option>';
                } else {
                    validSubjects.forEach(ss => {
                        subjectSelect.innerHTML += `<option value="${ss.studentSubjectId}">${ss.subject?.subjectName || 'مادة بدون اسم'} (د. ${ss.lecturer?.lastName || ''})</option>`;
                    });
                }
            } else {
                subjectSelect.innerHTML = '<option value="">لا توجد مواد مسجلة - تواصل مع الأدمن</option>';
            }

            // تحميل الأسئلة
            const questionsResult = await QuestionsAPI.getAll();
            if (questionsResult.success) {
                questions = questionsResult.data;
            }
        }

        // عند اختيار المادة
        document.getElementById('subjectSelect').addEventListener('change', function () {
            const studentSubjectId = this.value;
            const container = document.getElementById('questionsContainer');
            const submitBtn = document.getElementById('submitBtn');
            const lecturerInfo = document.getElementById('lecturerInfo');

            if (!studentSubjectId) {
                container.style.display = 'none';
                submitBtn.style.display = 'none';
                lecturerInfo.style.display = 'none';
                return;
            }

            // البحث عن تفاصيل المادة والمحاضر المختار
            const selected = studentSubjects.find(ss => ss.studentSubjectId == studentSubjectId);

            if (selected && selected.lecturer) {
                document.getElementById('lecturerName').textContent = selected.lecturer.firstName + ' ' + selected.lecturer.lastName;
                document.getElementById('lecturerId').value = selected.lecturerId;
                document.getElementById('subjectId').value = selected.subjectId;

                lecturerInfo.style.display = 'block';
                renderQuestions();
                container.style.display = 'block';
                submitBtn.style.display = 'block';
            }
        });

        function renderQuestions() {
            const container = document.getElementById('questionsContainer');
            if (questions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: gray;">لا توجد أسئلة - تواصل مع الأدمن</p>';
                return;
            }

            container.innerHTML = questions.map((q, i) => `
                <div class="card" style="margin-top: 15px;">
                    <p style="margin-bottom: 15px; font-weight: 500;">${i + 1}. ${q.questionText}</p>
                    <div class="rating" data-question="${q.questionId}">
                        ${[1, 2, 3, 4, 5].map(n => `<span class="star" data-value="${n}">★</span>`).join('')}
                    </div>
                    <input type="hidden" name="rating_${q.questionId}" value="0">
                </div>
            `).join('');

            // إضافة events للنجوم
            document.querySelectorAll('.rating').forEach(rating => {
                rating.querySelectorAll('.star').forEach(star => {
                    star.addEventListener('click', function () {
                        const value = this.dataset.value;
                        const questionId = this.parentElement.dataset.question;
                        document.querySelector(`input[name="rating_${questionId}"]`).value = value;

                        this.parentElement.querySelectorAll('.star').forEach((s, i) => {
                            s.classList.toggle('active', i < value);
                        });
                    });
                });
            });
        }

        document.getElementById('evaluationForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const lecturerId = document.getElementById('lecturerId').value;
            const subjectId = document.getElementById('subjectId').value;

            if (!lecturerId || !subjectId) {
                showAlert('حدث خطأ في تحديد المحاضر', 'danger');
                return;
            }

            let hasRating = false;
            let errorCount = 0;

            for (const q of questions) {
                const rating = document.querySelector(`input[name="rating_${q.questionId}"]`).value;
                if (rating > 0) {
                    hasRating = true;
                    const res = await EvaluationsAPI.add({
                        rating: parseInt(rating),
                        studentId: parseInt(studentId),
                        questionId: q.questionId,
                        lecturerId: parseInt(lecturerId),
                        subjectId: parseInt(subjectId)
                    });

                    if (!res.success) {
                        errorCount++;
                    }
                }
            }

            if (!hasRating) {
                showAlert('الرجاء تقييم سؤال واحد على الأقل', 'danger');
                return;
            }

            if (errorCount === 0) {
                showAlert('تم إرسال التقييم بنجاح! شكراً لك.');
                setTimeout(() => window.location.reload(), 2000);
            } else {
                showAlert(`تم حفظ التقييمات الجديدة. (ملاحظة: بعض الأسئلة تم تقييمها مسبقاً، لذا لم يتم تكرارها)`, 'info');
                setTimeout(() => window.location.reload(), 3000);
            }
        });

        loadData();
    </script>
</body>

</html>

================
File: all-ratings.html
Path: wwwroot\frontend\pages\all-ratings.html
================
<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProfRate - تقييمات كل المحاضرين</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-graduation-cap"></i> ProfRate</h1>
                <p>نظام تقييم المحاضرين</p>
            </div>
            <ul class="nav-menu">
                <li class="nav-item"><a href="lecturer-dashboard.html" class="nav-link"><i
                            class="fas fa-chart-line"></i><span>تقييماتي</span></a></li>
                <li class="nav-item"><a href="all-ratings.html" class="nav-link active"><i
                            class="fas fa-users"></i><span>تقييمات الجميع</span></a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="logout()"><i
                            class="fas fa-sign-out-alt"></i><span>تسجيل الخروج</span></a></li>
            </ul>
        </aside>

        <main class="main-content">
            <div class="page-header">
                <h2 class="page-title">تقييمات كل المحاضرين</h2>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ملخص تقييمات كل محاضر</h3>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>المحاضر</th>
                                <th>المادة</th>
                                <th>متوسط التقييم</th>
                                <th>عدد التقييمات</th>
                            </tr>
                        </thead>
                        <tbody id="ratingsTable">
                            <tr>
                                <td colspan="5" style="text-align: center;">جاري التحميل...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="../js/api.js"></script>
    <script>
        checkAuth();

        // عرض اسم المستخدم
        const fullName = localStorage.getItem('fullName');
        if (fullName && fullName !== 'null' && fullName !== 'undefined' && fullName !== '') {
            document.querySelector('.page-title').textContent = 'مرحباً: د.' + fullName;
        }

        async function loadRatings() {
            const result = await EvaluationsAPI.getReport();
            const tbody = document.getElementById('ratingsTable');

            if (!result.success || result.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">لا توجد تقييمات بعد</td></tr>';
                return;
            }

            tbody.innerHTML = result.data.map((r, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>${r.lecturerName}</td>
                    <td>${r.subjectName}</td>
                    <td>
                        <span style="color: ${r.averageRating >= 4 ? 'green' : r.averageRating >= 2.5 ? 'orange' : 'red'}; font-weight: bold;">
                            ${r.averageRating.toFixed(1)} / 5
                        </span>
                        <span style="color: gold;">${'★'.repeat(Math.round(r.averageRating))}</span>
                    </td>
                    <td>${r.totalEvaluations}</td>
                </tr>
            `).join('');
        }

        loadRatings();
    </script>
</body>

</html>

================
File: api.js
Path: wwwroot\frontend\js\api.js
================
// ===== ProfRate API Service =====

const API_URL = '/api';
// const API_URL = 'http://localhost:5176/api'; // استخدم هذا الرابط لو شغال Front-end Live Server بعيد عن الباك إند

// Helper function للـ API calls
async function apiCall(endpoint, method = 'GET', data = null) {
    const options = {
        method: method,
        headers: {
            'Content-Type': 'application/json'
        }
    };

    // إضافة الـ Token لو موجود
    const token = localStorage.getItem('token');
    if (token) {
        options.headers['Authorization'] = `Bearer ${token}`;
    }

    // إضافة الـ Body لو فيه Data
    if (data) {
        options.body = JSON.stringify(data);
    }

    try {
        const response = await fetch(`${API_URL}${endpoint}`, options);

        // Handle error responses
        if (!response.ok) {
            try {
                const errJson = await response.json();
                console.error('API Error Details:', errJson);

                if (response.status === 401) {
                    // لا تعمل redirect لو الـ endpoint هو login
                    if (!endpoint.includes('/auth/login')) {
                        localStorage.clear();
                        window.location.href = '/frontend/login.html';
                        return { success: false, data: { message: 'انتهت الجلسة' } };
                    }
                }
                return { success: false, data: errJson };
            } catch {
                // لو مش JSON
                console.error('API Error:', response.status, response.statusText);
                return { success: false, data: { message: `خطأ في الخادم: ${response.status}` } };
            }
        }

        const result = await response.json();
        return { success: true, data: result };

    } catch (error) {
        console.error('API Network Error:', error);

        if (error.message === 'Failed to fetch') {
            return { success: false, data: { message: 'لا يمكن الاتصال بالسيرفر، تأكد من تشغيل الباك إند' } };
        }
        return { success: false, data: { message: error.message || 'حدث خطأ غير متوقع' } };
    }
}

// ===== Auth API =====
const AuthAPI = {
    login: (username, password, userType) => {
        return apiCall('/auth/login', 'POST', { username, password, userType });
    }
};

// ===== Students API =====
const StudentsAPI = {
    getAll: (page = 1, pageSize = 20) => apiCall(`/students/GetAll?page=${page}&pageSize=${pageSize}`),
    search: (query) => apiCall(`/students/Search?query=${query}`),
    getById: (id) => apiCall(`/students/GetById/${id}`),
    add: (data) => apiCall('/students/Add', 'POST', data),
    update: (id, data) => apiCall(`/students/Update/${id}`, 'PUT', data),
    delete: (id) => apiCall(`/students/Delete/${id}`, 'DELETE')
};

// ===== StudentSubjects API =====
const StudentSubjectsAPI = {
    getAll: () => apiCall('/studentsubjects/GetAll'),
    getByStudent: (id) => apiCall(`/studentsubjects/GetByStudent/${id}`),
    getBySubject: (id) => apiCall(`/studentsubjects/GetBySubject/${id}`),
    add: (data) => apiCall('/studentsubjects/Add', 'POST', data),
    update: (id, data) => apiCall(`/studentsubjects/Update/${id}`, 'PUT', data),
    delete: (id) => apiCall(`/studentsubjects/Delete/${id}`, 'DELETE')
};

// ===== Lecturers API =====
const LecturersAPI = {
    getAll: () => apiCall('/lecturers/GetAll'),
    search: (query) => apiCall(`/lecturers/Search?query=${query}`),
    getById: (id) => apiCall(`/lecturers/GetById/${id}`),
    add: (data) => apiCall('/lecturers/Add', 'POST', data),
    update: (id, data) => apiCall(`/lecturers/Update/${id}`, 'PUT', data),
    delete: (id) => apiCall(`/lecturers/Delete/${id}`, 'DELETE')
};

// ===== LecturerSubjects API =====
const LecturerSubjectsAPI = {
    getAll: () => apiCall('/lecturersubjects/GetAll'),
    getByLecturer: (id) => apiCall(`/lecturersubjects/GetByLecturer/${id}`),
    getBySubject: (id) => apiCall(`/lecturersubjects/GetBySubject/${id}`),
    add: (data) => apiCall('/lecturersubjects/Add', 'POST', data),
    update: (id, data) => apiCall(`/lecturersubjects/Update/${id}`, 'PUT', data),
    delete: (id) => apiCall(`/lecturersubjects/Delete/${id}`, 'DELETE')
};

// ===== Questions API =====
const QuestionsAPI = {
    getAll: () => apiCall('/questions/GetAll'),
    add: (data) => apiCall('/questions/Add', 'POST', data),
    update: (id, data) => apiCall(`/questions/Update/${id}`, 'PUT', data),
    delete: (id) => apiCall(`/questions/Delete/${id}`, 'DELETE')
};

// ===== Subjects API =====
const SubjectsAPI = {
    getAll: () => apiCall('/subjects/GetAll'),
    add: (data) => apiCall('/subjects/Add', 'POST', data),
    update: (id, data) => apiCall(`/subjects/Update/${id}`, 'PUT', data),
    delete: (id) => apiCall(`/subjects/Delete/${id}`, 'DELETE')
};

// ===== Evaluations API =====
const EvaluationsAPI = {
    getAll: () => apiCall('/evaluations/GetAll'),
    getReport: () => apiCall('/evaluations/GetReport'),
    add: (data) => apiCall('/evaluations/Add', 'POST', data)
};

// ===== Helper Functions =====

// عرض Alert
function showAlert(message, type = 'success') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.textContent = message;

    const container = document.querySelector('.main-content') || document.body;
    container.insertBefore(alertDiv, container.firstChild);

    setTimeout(() => alertDiv.remove(), 3000);
}

// التحقق من تسجيل الدخول
function checkAuth() {
    const token = localStorage.getItem('token');
    const userType = localStorage.getItem('userType');

    if (!token) {
        window.location.href = '/frontend/login.html';
        return false;
    }
    return { token, userType };
}

// تسجيل الخروج
function logout() {
    localStorage.removeItem('token');
    localStorage.removeItem('userType');
    localStorage.removeItem('userId');
    window.location.href = '/frontend/login.html';
}

// إعداد قائمة بحث منسدلة (Searchable Dropdown)
function setupSearchDropdown(inputId, listId, apiSearchFn, onSelect) {
    const input = document.getElementById(inputId);
    const list = document.getElementById(listId);
    let timeout = null;

    input.addEventListener('input', function () {
        const query = this.value;
        if (query.length < 1) {
            list.style.display = 'none';
            return;
        }

        clearTimeout(timeout);
        timeout = setTimeout(async () => {
            const result = await apiSearchFn(query);
            if (result.success && result.data.length > 0) {
                list.innerHTML = result.data.map(item =>
                    `<div class="search-item" data-id="${item.studentId || item.lecturerId}">
                        ${item.firstName} ${item.lastName} (${item.username})
                    </div>`
                ).join('');
                list.style.display = 'block';

                // Handle Selection
                document.querySelectorAll(`#${listId} .search-item`).forEach(div => {
                    div.addEventListener('click', function () {
                        input.value = this.innerText;
                        list.style.display = 'none';
                        onSelect(this.getAttribute('data-id'));
                    });
                });
            } else {
                list.innerHTML = '<div class="search-item disabled">لا توجد نتائج</div>';
                list.style.display = 'block';
            }
        }, 300); // Debounce
    });

    // Hide list when clicking outside
    document.addEventListener('click', function (e) {
        if (e.target !== input && e.target !== list) {
            list.style.display = 'none';
        }
    });
}


================
File: style.css
Path: wwwroot\frontend\css\style.css
================
/* ===== ProfRate - Main Styles ===== */

/* CSS Variables - الألوان الأساسية */
:root {
    --primary: #667eea;
    --primary-dark: #5a67d8;
    --secondary: #764ba2;
    --success: #48bb78;
    --danger: #f56565;
    --warning: #ed8936;
    --dark: #2d3748;
    --light: #f7fafc;
    --gray: #a0aec0;
    --gradient: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
}

/* Reset */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--light);
    color: var(--dark);
    direction: rtl;
    min-height: 100vh;
}

/* ===== Layout ===== */
.app-container {
    display: flex;
    min-height: 100vh;
}

/* Sidebar */
.sidebar {
    width: 280px;
    background: var(--gradient);
    color: white;
    padding: 20px;
    position: fixed;
    height: 100vh;
    overflow-y: auto;
}

.sidebar-header {
    text-align: center;
    padding: 20px 0;
    border-bottom: 1px solid rgba(255,255,255,0.2);
    margin-bottom: 20px;
}

.sidebar-header h1 {
    font-size: 1.8rem;
    margin-bottom: 5px;
}

.sidebar-header p {
    opacity: 0.8;
    font-size: 0.9rem;
}

.nav-menu {
    list-style: none;
}

.nav-item {
    margin-bottom: 5px;
}

.nav-link {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 15px 20px;
    color: white;
    text-decoration: none;
    border-radius: 10px;
    transition: all 0.3s ease;
}

.nav-link:hover, .nav-link.active {
    background: rgba(255,255,255,0.2);
    transform: translateX(-5px);
}

.nav-link i {
    font-size: 1.2rem;
}

/* Main Content */
.main-content {
    flex: 1;
    margin-right: 280px;
    padding: 30px;
}

/* Header */
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid #e2e8f0;
}

.page-title {
    font-size: 1.8rem;
    color: var(--dark);
}

/* Cards */
.card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    padding: 25px;
    margin-bottom: 20px;
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e2e8f0;
}

.card-title {
    font-size: 1.3rem;
    color: var(--dark);
}

/* Stats Cards */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: var(--gradient);
    color: white;
    padding: 25px;
    border-radius: 15px;
    text-align: center;
}

.stat-card.green {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
}

.stat-card.orange {
    background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
}

.stat-card.red {
    background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
}

.stat-number {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 10px;
}

.stat-label {
    opacity: 0.9;
}

/* Tables */
.table-container {
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th, td {
    padding: 15px;
    text-align: right;
    border-bottom: 1px solid #e2e8f0;
}

th {
    background: var(--light);
    font-weight: 600;
    color: var(--dark);
}

tr:hover {
    background: #f7fafc;
}

/* Buttons */
.btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.btn-primary {
    background: var(--gradient);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.btn-success {
    background: var(--success);
    color: white;
}

.btn-danger {
    background: var(--danger);
    color: white;
}

.btn-sm {
    padding: 8px 16px;
    font-size: 0.9rem;
}

/* Forms */
.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--dark);
}

.form-control {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary);
}

select.form-control {
    cursor: pointer;
}

/* Modal */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}

.modal-overlay.active {
    display: flex;
}

.modal {
    background: white;
    border-radius: 15px;
    padding: 30px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--gray);
}

/* Alerts */
.alert {
    padding: 15px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.alert-success {
    background: #c6f6d5;
    color: #276749;
}

.alert-danger {
    background: #fed7d7;
    color: #c53030;
}

/* Login Page */
.login-container {
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    background: var(--gradient);
}

.login-card {
    background: white;
    padding: 40px;
    border-radius: 20px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
}

.login-header {
    text-align: center;
    margin-bottom: 30px;
}

.login-header h1 {
    color: var(--primary);
    margin-bottom: 10px;
}

/* Rating Stars */
.rating {
    display: flex;
    gap: 5px;
    direction: ltr;
}

.rating .star {
    font-size: 1.5rem;
    color: #e2e8f0;
    cursor: pointer;
    transition: color 0.2s;
}

.rating .star.active,
.rating .star:hover {
    color: #f6e05e;
}

/* Responsive */
@media (max-width: 768px) {
    .sidebar {
        width: 100%;
        position: relative;
        height: auto;
    }
    
    .main-content {
        margin-right: 0;
    }
    
    .app-container {
        flex-direction: column;
    }
}



