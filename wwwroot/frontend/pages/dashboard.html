<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1200">
    <title>Ù†Ø¸Ø§Ù… ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø­Ø§Ø¶Ø±ÙŠÙ† - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-graduation-cap"></i> ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø­Ø§Ø¶Ø±ÙŠÙ†</h1>
                <p>Ù†Ø¸Ø§Ù… ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø­Ø§Ø¶Ø±ÙŠÙ†</p>
            </div>

            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="dashboard.html" class="nav-link active">
                        <i class="fas fa-home"></i>
                        <span>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="students.html" class="nav-link">
                        <i class="fas fa-user-graduate"></i>
                        <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="lecturers.html" class="nav-link">
                        <i class="fas fa-chalkboard-teacher"></i>
                        <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±ÙŠÙ†</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="subjects.html" class="nav-link">
                        <i class="fas fa-book"></i>
                        <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="questions.html" class="nav-link">
                        <i class="fas fa-question-circle"></i>
                        <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="reports.html" class="nav-link">
                        <i class="fas fa-chart-bar"></i>
                        <span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
                    </a>
                </li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h2 class="page-title">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
                <h2 id="welcomeMessage" style="margin: 0;">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</h2>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="studentsCount">0</div>
                    <div class="stat-label">Ø§Ù„Ø·Ù„Ø§Ø¨</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-number" id="lecturersCount">0</div>
                    <div class="stat-label">Ø§Ù„Ù…Ø­Ø§Ø¶Ø±ÙŠÙ†</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-number" id="subjectsCount">0</div>
                    <div class="stat-label">Ø§Ù„Ù…ÙˆØ§Ø¯</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-number" id="evaluationsCount">0</div>
                    <div class="stat-label">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</div>
                </div>
            </div>

            <!-- Actions -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 class="card-title">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h3>
                </div>
                <div style="padding: 20px;">
                    <!-- Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… -->
                    <div style="margin-bottom: 20px; padding: 15px; border-radius: 10px; background: #f8f9fa;">
                        <span style="font-weight: bold;">Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: </span>
                        <span id="evaluationStatus" style="font-weight: bold;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                    </div>

                    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
                    <button id="openEvalBtn" onclick="openEvaluation()" class="btn"
                        style="background: #2ecc71; color: white; margin-left: 10px;">
                        <i class="fas fa-unlock"></i> ÙØªØ­ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù„Ù„Ø·Ù„Ø§Ø¨
                    </button>
                    <button id="closeEvalBtn" onclick="closeEvaluation()" class="btn"
                        style="background: #e74c3c; color: white; margin-left: 10px;">
                        <i class="fas fa-lock"></i> Ù‚ÙÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
                    </button>
                    <button onclick="resetEvaluations()" class="btn btn-danger" style="margin-left: 10px;">
                        <i class="fas fa-redo-alt"></i> Ø£Ø±Ø´ÙØ© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
                    </button>
                </div>
            </div>

            <!-- Recent Evaluations -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Ø¢Ø®Ø± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</h3>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Ø§Ù„Ù…Ø­Ø§Ø¶Ø±</th>
                                <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                                <th>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th>
                            </tr>
                        </thead>
                        <tbody id="recentEvaluations">
                            <tr>
                                <td colspan="4" style="text-align: center;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Custom Confirm Modal -->
    <div class="confirm-modal-overlay" id="confirmModal">
        <div class="confirm-modal">
            <div class="confirm-modal-icon warning">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</h3>
            <p id="confirmMessage">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ØŸ</p>
            <div class="confirm-modal-buttons">
                <button class="btn btn-danger" id="confirmYes">Ù†Ø¹Ù…ØŒ ØªØ£ÙƒÙŠØ¯</button>
                <button class="btn" id="confirmNo" style="background: #e2e8f0;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script>
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        checkAuth();

        // ========== Custom Confirm Function ==========
        function showConfirm(message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                document.getElementById('confirmMessage').textContent = message;
                modal.classList.add('active');

                document.getElementById('confirmYes').onclick = () => {
                    modal.classList.remove('active');
                    resolve(true);
                };

                document.getElementById('confirmNo').onclick = () => {
                    modal.classList.remove('active');
                    resolve(false);
                };
            });
        }

        // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const fullName = localStorage.getItem('fullName');
        const firstName = localStorage.getItem('firstName');
        if (fullName && fullName !== 'null' && fullName !== 'undefined' && fullName !== '') {
            document.getElementById('welcomeMessage').textContent = 'Ù…Ø±Ø­Ø¨Ø§Ù‹: ' + fullName;
        } else if (firstName && firstName !== 'null' && firstName !== 'undefined' && firstName !== '') {
            document.getElementById('welcomeMessage').textContent = 'Ù…Ø±Ø­Ø¨Ø§Ù‹: ' + firstName;
        }

        // Ø®Ø±ÙŠØ·Ø© Ù„ØªØ®Ø²ÙŠÙ† Ù…ÙˆØ§Ø¯ ÙƒÙ„ Ù…Ø­Ø§Ø¶Ø±
        let lecturersMap = {};

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        async function loadStats() {
            // Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨
            const students = await StudentsAPI.getAll();
            if (students.success) {
                // Students returns PagedResult, so check totalCount
                document.getElementById('studentsCount').textContent = students.data.totalCount || 0;
            }

            // Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±ÙŠÙ†
            const lecturers = await LecturersAPI.getAll();
            if (lecturers.success) {
                document.getElementById('lecturersCount').textContent = lecturers.data.length;
                // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯ Ù„ÙƒÙ„ Ù…Ø­Ø§Ø¶Ø±
                lecturers.data.forEach(l => {
                    lecturersMap[l.lecturerId] = l.subjects && l.subjects.length > 0 ? l.subjects.join(' / ') : '';
                });
            }

            // Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯
            const subjects = await SubjectsAPI.getAll();
            if (subjects.success) {
                document.getElementById('subjectsCount').textContent = subjects.data.length;
            }

            // Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
            const evaluations = await EvaluationsAPI.getAll();
            if (evaluations.success) {
                document.getElementById('evaluationsCount').textContent = evaluations.data.length;
                loadRecentEvaluations(evaluations.data);
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø¢Ø®Ø± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
        function loadRecentEvaluations(evaluations) {
            const tbody = document.getElementById('recentEvaluations');

            if (evaluations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª</td></tr>';
                return;
            }

            const recent = evaluations.slice(-5).reverse();
            tbody.innerHTML = recent.map((e, i) => {
                // Ø§Ù‚ØªØ·Ø§Ø¹ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù„Ùˆ Ø·ÙˆÙŠÙ„Ø©
                const answer = e.textAnswer || '';
                const shortAnswer = answer.length > 50 ? answer.substring(0, 50) + '...' : answer;
                // Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ Ù„Ù„Ù…Ø­Ø§Ø¶Ø± Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø©
                const lecturerSubjects = lecturersMap[e.lecturerId] || e.subjectName || '-';

                return `
                <tr>
                    <td>${i + 1}</td>
                    <td>${e.lecturerName || ''}</td>
                    <td>${lecturerSubjects}</td>
                    <td style="max-width: 300px;">${shortAnswer || '-'}</td>
                </tr>
            `}).join('');
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        async function resetEvaluations() {
            const confirmed = await showConfirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¨Ø¯Ø¡ Ø¯ÙˆØ±Ø© ØªÙ‚ÙŠÙŠÙ… Ø¬Ø¯ÙŠØ¯Ø©ØŸ Ø³ÙŠØªÙ… Ø£Ø±Ø´ÙØ© Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆÙ„Ù† ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©.');
            if (confirmed) {
                const result = await apiCall('/evaluations/Reset', 'POST');
                if (result.success) {
                    showAlert(result.data.message);
                    loadStats();
                } else {
                    showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·', 'danger');
                }
            }
        }

        // === Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ ÙØªØ­/Ù‚ÙÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ===
        async function checkEvaluationStatus() {
            const res = await apiCall('/settings/IsEvaluationOpen', 'GET');
            console.log('Evaluation status response:', res);
            if (res.success && res.data) {
                updateEvaluationStatusUI(res.data.isOpen);
            } else {
                // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ - Ù†ÙØªØ±Ø¶ Ù…ÙØªÙˆØ­ ÙˆÙ†Ø¸Ù‡Ø± Ø§Ù„Ø²Ø±Ø§Ø±ÙŠÙ†
                console.error('Failed to get evaluation status:', res);
                document.getElementById('evaluationStatus').innerHTML = '<span style="color: orange;">âš ï¸ ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>';
                document.getElementById('openEvalBtn').style.display = 'inline-block';
                document.getElementById('closeEvalBtn').style.display = 'inline-block';
            }
        }

        function updateEvaluationStatusUI(isOpen) {
            const statusEl = document.getElementById('evaluationStatus');
            const openBtn = document.getElementById('openEvalBtn');
            const closeBtn = document.getElementById('closeEvalBtn');

            if (isOpen) {
                statusEl.innerHTML = '<span style="color: #2ecc71;">ğŸŸ¢ Ù…ÙØªÙˆØ­</span>';
                openBtn.style.display = 'none';
                closeBtn.style.display = 'inline-block';
            } else {
                statusEl.innerHTML = '<span style="color: #e74c3c;">ğŸ”´ Ù…ØºÙ„Ù‚</span>';
                openBtn.style.display = 'inline-block';
                closeBtn.style.display = 'none';
            }
        }

        async function openEvaluation() {
            const confirmed = await showConfirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ÙØªØ­ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù„Ù„Ø·Ù„Ø§Ø¨ØŸ');
            if (confirmed) {
                const res = await apiCall('/settings/OpenEvaluation', 'POST');
                if (res.success) {
                    showAlert(res.data.message);
                    updateEvaluationStatusUI(true);
                } else {
                    showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£', 'danger');
                }
            }
        }

        async function closeEvaluation() {
            const confirmed = await showConfirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù‚ÙÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…ØŸ Ù„Ù† ÙŠØªÙ…ÙƒÙ† Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† Ø§Ù„ØªÙ‚ÙŠÙŠÙ….');
            if (confirmed) {
                const res = await apiCall('/settings/CloseEvaluation', 'POST');
                if (res.success) {
                    showAlert(res.data.message);
                    updateEvaluationStatusUI(false);
                } else {
                    showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£', 'danger');
                }
            }
        }

        loadStats();
        checkEvaluationStatus();
    </script>
</body>

</html>