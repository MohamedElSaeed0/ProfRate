<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1200">
    <title>نظام تقييم المحاضرين - تقييم المحاضرين</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-graduation-cap"></i> تقييم المحاضرين</h1>
                <p>نظام تقييم المحاضرين</p>
            </div>
            <ul class="nav-menu">
                <li class="nav-item"><a href="student-dashboard.html" class="nav-link"><i
                            class="fas fa-home"></i><span>الرئيسية</span></a></li>
                <li class="nav-item"><a href="evaluate.html" class="nav-link active"><i
                            class="fas fa-star"></i><span>تقييم المحاضرين</span></a></li>
                <li class="nav-item"><a href="view-ratings.html" class="nav-link"><i class="fas fa-eye"></i><span>عرض
                            التقييمات</span></a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="logout()"><i
                            class="fas fa-sign-out-alt"></i><span>تسجيل الخروج</span></a></li>
            </ul>
        </aside>

        <main class="main-content">
            <div class="page-header">
                <h2 class="page-title">تقييم المحاضرين</h2>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">تقييم المحاضرين</h3>
                </div>

                <form id="evaluationForm">
                    <div class="form-group">
                        <label class="form-label">اختر المحاضر للتقييم</label>
                        <select class="form-control" id="lecturerSelect" required>
                            <option value="">اختر المحاضر</option>
                        </select>
                    </div>

                    <div id="lecturerInfo"
                        style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0;">المحاضر: <span id="lecturerName"
                                style="color: var(--primary-color);"></span></h4>
                        <input type="hidden" id="lecturerId">
                        <input type="hidden" id="subjectId">
                    </div>

                    <div id="questionsContainer" style="display: none;">
                        <!-- الأسئلة ستظهر هنا -->
                    </div>

                    <button type="submit" id="submitBtn" class="btn btn-primary"
                        style="width: 100%; margin-top: 20px; display: none;">
                        <i class="fas fa-paper-plane"></i>
                        إرسال التقييم
                    </button>
                </form>
            </div>
        </main>
    </div>

    <script src="../js/api.js"></script>
    <script>
        checkAuth();

        const studentId = localStorage.getItem('userId');
        let questions = [];
        let studentSubjects = [];
        let isEvaluationOpen = true;

        async function loadData() {
            // التحقق هل التقييم مفتوح أولاً
            const statusRes = await apiCall('/settings/IsEvaluationOpen', 'GET');
            if (statusRes.success && !statusRes.data.isOpen) {
                isEvaluationOpen = false;
                document.getElementById('lecturerSelect').innerHTML = '<option value="">التقييم مغلق حالياً</option>';
                document.getElementById('lecturerSelect').disabled = true;
                document.getElementById('questionsContainer').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #e74c3c;">
                        <i class="fas fa-lock" style="font-size: 48px; margin-bottom: 20px;"></i>
                        <h3>عفواً، التقييم مغلق حالياً</h3>
                        <p>يرجى المحاولة لاحقاً عند فتح فترة التقييم</p>
                    </div>
                `;
                document.getElementById('questionsContainer').style.display = 'block';
                document.getElementById('submitBtn').style.display = 'none';
                return;
            }

            // تحميل المواد المسجل فيها الطالب مع المحاضرين
            const mySubjects = await apiCall(`/studentsubjects/GetByStudent/${studentId}`);
            const lecturerSelect = document.getElementById('lecturerSelect');

            if (mySubjects.success && mySubjects.data.length > 0) {
                studentSubjects = mySubjects.data;

                // فلتر المواد اللي ملهاش محاضر
                const validSubjects = studentSubjects.filter(ss => ss.lecturerId != null);

                // استخراج المحاضرين الفريدين مع كل موادهم
                const lecturerMap = new Map();

                validSubjects.forEach(ss => {
                    if (!lecturerMap.has(ss.lecturerId)) {
                        lecturerMap.set(ss.lecturerId, {
                            lecturerId: ss.lecturerId,
                            lecturerName: (ss.lecturer?.firstName || '') + ' ' + (ss.lecturer?.lastName || ''),
                            subjectId: ss.subjectId, // أول مادة للحفظ في الـ DB
                            subjects: [ss.subject?.subjectName || '']
                        });
                    } else {
                        // إضافة المادة لقائمة مواد المحاضر
                        const lec = lecturerMap.get(ss.lecturerId);
                        if (ss.subject?.subjectName && !lec.subjects.includes(ss.subject.subjectName)) {
                            lec.subjects.push(ss.subject.subjectName);
                        }
                    }
                });

                const uniqueLecturers = Array.from(lecturerMap.values());

                if (uniqueLecturers.length === 0) {
                    lecturerSelect.innerHTML = '<option value="">لا يوجد محاضرين - تواصل مع الأدمن</option>';
                } else {
                    uniqueLecturers.forEach(lec => {
                        lecturerSelect.innerHTML += `<option value="${lec.lecturerId}" data-subject="${lec.subjectId}">د. ${lec.lecturerName}</option>`;
                    });
                }
            } else {
                lecturerSelect.innerHTML = '<option value="">لا توجد مواد مسجلة - تواصل مع الأدمن</option>';
            }

            // تحميل الأسئلة
            const questionsResult = await QuestionsAPI.getAll();
            if (questionsResult.success) {
                questions = questionsResult.data;
            }
        }

        // عند اختيار المحاضر
        document.getElementById('lecturerSelect').addEventListener('change', function () {
            const lecturerId = this.value;
            const container = document.getElementById('questionsContainer');
            const submitBtn = document.getElementById('submitBtn');
            const lecturerInfo = document.getElementById('lecturerInfo');

            if (!lecturerId) {
                container.style.display = 'none';
                submitBtn.style.display = 'none';
                lecturerInfo.style.display = 'none';
                return;
            }

            // الحصول على الـ SubjectId من الـ data attribute
            const selectedOption = this.options[this.selectedIndex];
            const subjectId = selectedOption.dataset.subject;
            const lecturerName = selectedOption.textContent;

            document.getElementById('lecturerName').textContent = lecturerName;
            document.getElementById('lecturerId').value = lecturerId;
            document.getElementById('subjectId').value = subjectId;

            lecturerInfo.style.display = 'block';
            renderQuestions();
            container.style.display = 'block';
            submitBtn.style.display = 'block';
        });

        function renderQuestions() {
            const container = document.getElementById('questionsContainer');
            if (questions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: gray;">لا توجد أسئلة - تواصل مع الأدمن</p>';
                return;
            }

            container.innerHTML = questions.map((q, i) => `
                <div class="card" style="margin-top: 15px;">
                    <p style="margin-bottom: 15px; font-weight: 500;">${i + 1}. ${q.questionText}</p>
                    <textarea name="answer_${q.questionId}" class="form-control" 
                        placeholder="اكتب إجابتك هنا (400 حرف كحد أقصى)..." 
                        maxlength="400" rows="4" style="resize: vertical;"></textarea>
                    <small style="color: gray; display: block; text-align: left; margin-top: 5px;">
                        <span class="char-count-${q.questionId}">0</span>/400
                    </small>
                </div>
            `).join('');

            // إضافة عداد الحروف
            questions.forEach(q => {
                const textarea = document.querySelector(`textarea[name="answer_${q.questionId}"]`);
                textarea.addEventListener('input', function () {
                    document.querySelector(`.char-count-${q.questionId}`).textContent = this.value.length;
                });
            });
        }

        document.getElementById('evaluationForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const lecturerId = document.getElementById('lecturerId').value;
            const subjectId = document.getElementById('subjectId').value;

            if (!lecturerId || !subjectId) {
                showAlert('حدث خطأ في تحديد المحاضر', 'danger');
                return;
            }

            let hasAnswer = false;
            let errorCount = 0;
            let successCount = 0;

            for (const q of questions) {
                const answer = document.querySelector(`textarea[name="answer_${q.questionId}"]`).value.trim();
                if (answer.length > 0) {
                    hasAnswer = true;
                    const res = await EvaluationsAPI.add({
                        textAnswer: answer,
                        studentId: parseInt(studentId),
                        questionId: q.questionId,
                        lecturerId: parseInt(lecturerId),
                        subjectId: parseInt(subjectId)
                    });

                    if (res.success) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                }
            }

            if (!hasAnswer) {
                showAlert('الرجاء الإجابة على سؤال واحد على الأقل', 'danger');
                return;
            }

            if (errorCount === 0) {
                showAlert('تم إرسال تقييمك بنجاح! شكراً لك.');
                resetForm();
            } else if (successCount === 0) {
                showAlert('لقد قمت بتقييم هذا المحاضر في هذه المادة من قبل!', 'danger');
            } else {
                showAlert('تم حفظ بعض الإجابات. (بعض الأسئلة كانت مُجاب عليها مسبقاً)', 'info');
                resetForm();
            }
        });

        function resetForm() {
            document.getElementById('subjectSelect').value = '';
            document.getElementById('questionsContainer').style.display = 'none';
            document.getElementById('submitBtn').style.display = 'none';
            document.getElementById('lecturerInfo').style.display = 'none';
        }

        loadData();
    </script>
</body>

</html>